<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∞èÈúÅÁöÑÂ∞èÊâãÊú∫</title>
    <!-- Âä®ÊÄÅËÅäÂ§©Ê†∑ÂºèÊ≥®ÂÖ•ÁÇπ -->
    <style id="dynamic-chat-style"></style>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        /* ÊâãÊú∫Â±èÂπïÂÆπÂô® */
        .phone-screen {
            width: 390px;
            height: 844px;
            background-color: #FFECF0; /* ‚ë†Âè∑ÁïåÈù¢Ê∑°Á≤âËâ≤ */
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* ÂÖ®Â±Ä Home Indicator */
        .home-indicator-area {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30px;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .home-indicator {
            width: 130px;
            height: 5px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 100px;
            transition: background-color 0.3s;
        }
        .app-active .home-indicator {
            background-color: #1a1a1a;
        }

        /* ----- Ê°åÈù¢ÂÆπÂô® ----- */
        #desktop {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 100px 25px 30px;
            gap: 30px;
            transition: transform 0.3s ease;
        }

        /* È°∂ÈÉ®ÊØõÁéªÁíÉÂç°Áâá */
        .glass-card {
            width: 100%;
            height: 180px;
            background: rgba(255, 250, 252, 0.45);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(236, 184, 199, 0.15);
            display: flex;
            align-items: center;
            padding: 20px;
            gap: 20px;
            flex-shrink: 0;
        }

        .avatar-wrapper {
            width: 100px;
            height: 100px;
            flex-shrink: 0;
            position: relative;
        }

        .avatar-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            border: 3px solid #fff;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: #dcb0ba;
            font-weight: bold;
            font-size: 18px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .input-group {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 15px;
        }

        .custom-input {
            width: 100%;
            border: none;
            background: transparent;
            border-bottom: 2px solid rgba(255, 255, 255, 0.6);
            padding: 8px 0;
            font-size: 16px;
            color: #555;
            outline: none;
            transition: border-color 0.3s;
        }
        .custom-input:focus { border-bottom-color: #ffb7c5; }

        /* ‰∏≠ÈÉ®Âå∫Âüü */
        .middle-section {
            display: flex;
            gap: 20px;
            width: 100%;
            flex-grow: 1; /* Â°´ÂÖÖÁ©∫Èó¥ */
            align-items: flex-start;
        }

        /* Ê°åÈù¢Â§áÂøòÂΩïÂ∞èÁªÑ‰ª∂ */
        .widget-memo {
            width: 155px;
            height: 155px;
            background-color: #fffdf5;
            border-radius: 25px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            transition: transform 0.1s;
        }
        .widget-memo:active { transform: scale(0.95); }

        .widget-memo-content-layer {
            position: relative;
            z-index: 2;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .widget-memo-title { display: none; }
        .widget-memo-text { display: none; }

        /* App Grid */
        .app-grid-2x2 {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 60px 60px;
            gap: 35px;
            justify-items: center;
            align-items: start;
        }

        .app-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            width: 60px;
            cursor: pointer;
        }
        .app-icon {
            width: 60px; height: 60px;
            border-radius: 14px;
            background-color: #fff;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; color: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
        }
        .app-name {
            font-size: 11px; color: #555;
            text-shadow: 0 1px 2px rgba(255,255,255,0.5);
            text-align: center; width: 70px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        
        /* ÂæÆ‰ø°Êú™ËØªÁ∫¢ÁÇπ */
        .badge {
            position: absolute;
            top: -5px; right: -5px;
            background-color: #ff3b30;
            color: white;
            font-size: 10px;
            font-weight: bold;
            height: 18px;
            min-width: 18px;
            border-radius: 9px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 4px;
            border: 1px solid white;
        }

        .icon-wechat { background: linear-gradient(135deg, #09b83e, #059632); }
        .icon-worldbook { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .icon-settings-app { background: linear-gradient(135deg, #8c9299, #545960); }
        .icon-themes { background: linear-gradient(135deg, #ff9a9e, #fecfef); }
        .icon-placeholder { background: linear-gradient(135deg, #e0c3fc, #8ec5fc); }
        .icon-placeholder.empty { background: rgba(255,255,255,0.4); border: 2px dashed rgba(255,255,255,0.8); box-shadow: none; }

        .app-icon svg { width: 34px; height: 34px; fill: white; }

        /* Dock Bar */
        .dock-bar {
            position: absolute;
            bottom: 25px;
            left: 20px;
            right: 20px;
            height: 90px;
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 35px;
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 10;
        }

        /* ================= App ÂÆπÂô®ÈÄöÁî®Ê†∑Âºè ================= */
        .app-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .app-container.active { transform: translateX(0); }

        /* ----- Â§áÂøòÂΩï App ----- */
        #memo-app { background-color: #FFECF0; }

        .app-header {
            height: 100px;
            padding: 50px 20px 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            background: rgba(255, 236, 240, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: relative;
        }
        .header-btn {
            color: #dcb0ba;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            padding: 5px;
        }
        .header-title { font-size: 18px; font-weight: bold; color: #333; }

        .memo-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px 20px 100px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .memo-item {
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.2s, background 0.2s;
            position: relative;
            overflow: hidden;
        }
        .memo-item:active { transform: scale(0.98); background: #fdfdfd; }
        .memo-item.pinned { border-left: 4px solid #f5bd42; }

        .memo-select-circle {
            width: 22px; height: 22px;
            border-radius: 50%;
            border: 2px solid #ddd;
            display: none;
            flex-shrink: 0;
        }
        .memo-item.selected .memo-select-circle {
            background-color: #dcb0ba;
            border-color: #dcb0ba;
            position: relative;
        }
        .memo-item.selected .memo-select-circle::after {
            content: "‚úì"; color: white;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }
        .memo-list.selection-mode .memo-select-circle { display: block; }

        .memo-info { flex-grow: 1; min-width: 0; }
        .memo-item-title { font-weight: bold; font-size: 16px; margin-bottom: 4px; color: #333; }
        .memo-item-preview { font-size: 13px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .memo-item-date { font-size: 11px; color: #aaa; margin-top: 5px; }

        .app-footer {
            height: 80px;
            background: rgba(255, 236, 240, 0.95);
            border-top: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 20px;
        }
        .create-memo-btn {
            width: 90%;
            height: 44px;
            background: #dcb0ba;
            border-radius: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(220, 176, 186, 0.4);
            cursor: pointer;
        }
        .selection-footer {
            display: none; width: 100%; justify-content: space-between; padding: 0 30px;
            color: #dcb0ba; font-weight: 500;
        }
        .app-footer.selection-mode .create-memo-btn { display: none; }
        .app-footer.selection-mode .selection-footer { display: flex; }

        /* ----- ËÆæÁΩÆ App ----- */
        #settings-app { background-color: #f2f2f7; }
        #settings-app .app-header { background: #f2f2f7; border-bottom: 1px solid #c6c6c8; }
        
        .settings-group {
            margin-top: 20px;
            background: #fff;
            border-top: 1px solid #c6c6c8;
            border-bottom: 1px solid #c6c6c8;
            padding-left: 20px;
        }
        .settings-row {
            display: flex;
            align-items: center;
            padding: 12px 20px 12px 0;
            border-bottom: 1px solid #c6c6c8;
            font-size: 17px;
        }
        .settings-row:last-child { border-bottom: none; }
        .settings-label { width: 100px; color: #000; }
        .settings-input {
            flex: 1;
            border: none;
            outline: none;
            text-align: right;
            font-size: 17px;
            color: #8e8e93;
            background: transparent;
            font-family: inherit;
        }

        /* ----- ÂæÆ‰ø° App ----- */
        #wechat-app { background-color: #ededed; display: flex; flex-direction: column; }
        
        .wechat-pages {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            display: flex;
        }
        
        .wechat-page {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            display: none;
            flex-direction: column;
            background-color: #ededed;
        }
        .wechat-page.active { display: flex; }

        /* ÂæÆ‰ø°Â§¥ÈÉ® */
        .wechat-header {
            height: 90px;
            background: #ededed;
            padding: 45px 15px 10px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #dcdcdc;
            position: relative;
            z-index: 10;
        }
        .wechat-back-btn {
            font-size: 18px; color: #000; margin-right: 10px; cursor: pointer;
            padding: 5px; font-weight: bold;
        }
        .wechat-title { font-size: 17px; font-weight: 600; color: #000; flex-grow: 1; }
        .wechat-header-icons { display: flex; gap: 15px; }
        .wechat-icon { width: 24px; height: 24px; fill: #000; }

        /* ÂæÆ‰ø°Âè≥‰∏äËßíËèúÂçï */
        #wechat-plus-menu {
            position: absolute;
            top: 90px; right: 10px;
            background: #4c4c4c;
            border-radius: 6px;
            padding: 0;
            display: none;
            flex-direction: column;
            z-index: 200;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            width: 150px;
        }
        #wechat-plus-menu.active { display: flex; }
        #wechat-plus-menu::before {
            content: ""; position: absolute; top: -6px; right: 15px;
            border-left: 6px solid transparent; border-right: 6px solid transparent;
            border-bottom: 6px solid #4c4c4c;
        }
        .wechat-menu-item {
            padding: 12px 15px;
            color: #fff;
            font-size: 14px;
            display: flex; align-items: center; gap: 10px;
            border-bottom: 1px solid #5d5d5d;
            cursor: pointer;
        }
        .wechat-menu-item:last-child { border-bottom: none; }
        .wechat-menu-item:active { background: #5d5d5d; }
        .wechat-menu-icon { width: 20px; height: 20px; fill: #fff; }

        /* ÂæÆ‰ø°Ê∑ªÂä†Â•ΩÂèãÂºπÁ™ó */
        #wechat-input-modal-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 1001;
            display: none; justify-content: center; align-items: center;
        }
        #wechat-input-modal-mask.active { display: flex; }
        .wechat-input-box {
            width: 280px; background: #fff; border-radius: 8px; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .wechat-input-header { padding: 20px; text-align: center; font-weight: 600; font-size: 17px; }
        .wechat-input-body { padding: 0 20px 20px; }
        .wechat-name-input {
            width: 100%; height: 40px; background: #f5f5f5; border: none; padding: 10px;
            outline: none; font-size: 16px; border-radius: 4px;
        }
        .wechat-input-footer { display: flex; border-top: 1px solid #eee; }
        .wechat-input-btn {
            flex: 1; padding: 15px; text-align: center; font-size: 17px;
            border-right: 1px solid #eee; cursor: pointer; color: #576b95; font-weight: 600;
        }
        .wechat-input-btn:last-child { border-right: none; }
        .wechat-input-btn.cancel { color: #000; font-weight: 400; }

        /* ÂæÆ‰ø°ËÅäÂ§©ËÆæÁΩÆÂºπÁ™ó (‰∫∫ËÆæ) */
        #wechat-settings-modal {
            position: absolute;
            top: 5%; left: 5%; right: 5%; bottom: 5%;
            background: #f7f7f7;
            border-radius: 12px;
            z-index: 2000;
            display: none;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.2);
            overflow: hidden;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #wechat-settings-modal.active { display: flex; transform: scale(1); opacity: 1; }
        
        .ws-header {
            height: 50px; background: #fff; border-bottom: 1px solid #eee;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 17px; flex-shrink: 0;
        }
        .ws-body {
            flex-grow: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 20px;
        }
        
        .ws-section-title { font-size: 13px; color: #888; margin-bottom: 5px; margin-left: 5px; }
        .ws-card { background: #fff; border-radius: 8px; overflow: hidden; }
        .ws-row {
            display: flex; align-items: center; padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .ws-row:last-child { border-bottom: none; }
        .ws-label { width: 80px; font-size: 16px; }
        .ws-value { flex-grow: 1; font-size: 16px; color: #333; }
        .ws-input {
            width: 100%; border: none; outline: none; font-size: 16px;
            font-family: inherit; color: #333; text-align: right;
        }
        .ws-textarea {
            width: 100%; border: none; outline: none; font-size: 15px;
            font-family: inherit; color: #333; resize: none; min-height: 80px;
            background: transparent;
        }
        
        .ws-avatar-preview {
            width: 40px; height: 40px; border-radius: 4px; background: #ddd;
            display: flex; justify-content: center; align-items: center;
            margin-left: auto; color: white; overflow: hidden;
        }
        
        .ws-footer {
            height: 60px; background: #fff; border-top: 1px solid #eee;
            display: flex; align-items: center; justify-content: space-around;
            flex-shrink: 0;
        }
        .ws-btn {
            padding: 10px 20px; border-radius: 6px; font-size: 16px; cursor: pointer;
            min-width: 80px; text-align: center;
        }
        .ws-btn.cancel { color: #555; background: #f0f0f0; }
        .ws-btn.save { color: #fff; background: #07C160; }
        .ws-btn.back { color: #576b95; background: transparent; border: 1px solid #f0f0f0; }

        .wechat-list {
            flex-grow: 1;
            overflow-y: auto;
            background: #fff;
            padding-bottom: 20px;
        }
        .wechat-item {
            display: flex;
            height: 72px;
            padding: 10px 15px;
            background: #fff;
            align-items: center;
            cursor: pointer;
        }
        .wechat-item:active { background: #f5f5f5; }
        
        .wechat-avatar {
            width: 48px; height: 48px;
            border-radius: 6px;
            background: #ddd;
            margin-right: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            flex-shrink: 0;
            color: #fff;
            overflow: hidden;
        }
        .wechat-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .wechat-avatar.green { background: #07C160; }
        .wechat-avatar.orange { background: #fa9d3b; }
        .wechat-avatar.blue { background: #10aeff; }
        
        .wechat-content {
            flex-grow: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-bottom: 1px solid #f0f0f0;
            padding-right: 10px;
            min-width: 0;
        }
        .wechat-item:last-child .wechat-content { border-bottom: none; }
        
        .wechat-row-1 { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .wechat-name { font-size: 16px; font-weight: 500; color: #000; }
        .wechat-time { font-size: 11px; color: #b2b2b2; }
        
        .wechat-row-2 { display: flex; }
        .wechat-msg { font-size: 13px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ÂèëÁé∞È°µ & ÊàëÈ°µ ÂàóË°®Ê†∑Âºè */
        .wechat-cell-group { margin-top: 10px; background: #fff; border-top: 1px solid #e5e5e5; border-bottom: 1px solid #e5e5e5; }
        .wechat-cell {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            position: relative;
        }
        .wechat-cell:active { background: #f5f5f5; }
        .wechat-cell::after {
            content: "";
            position: absolute; bottom: 0; left: 60px; right: 0;
            height: 1px; background: #e5e5e5;
            transform: scaleY(0.5);
        }
        .wechat-cell:last-child::after { display: none; }
        
        .wechat-cell-icon { width: 24px; height: 24px; margin-right: 16px; }
        .wechat-cell-text { flex-grow: 1; font-size: 17px; color: #000; }
        .wechat-cell-arrow { width: 8px; height: 8px; border-top: 2px solid #b2b2b2; border-right: 2px solid #b2b2b2; transform: rotate(45deg); }

        /* Â∫ïÈÉ®ÂØºËà™ */
        .wechat-tabbar {
            height: 85px; /* ÂåÖÂê´ Home Indicator Âå∫Âüü */
            background: #f7f7f7;
            border-top: 1px solid #dcdcdc;
            display: flex;
            padding-bottom: 25px;
            z-index: 50;
        }
        .wechat-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            color: #000;
        }
        .wechat-tab.active .wechat-tab-icon { fill: #07C160; }
        .wechat-tab.active .wechat-tab-label { color: #07C160; }
        
        .wechat-tab-icon { width: 26px; height: 26px; fill: #000; transition: fill 0.2s; }
        .wechat-tab-label { font-size: 10px; font-weight: 500; transition: color 0.2s; }

        /* ----- ËÅäÂ§©ËØ¶ÊÉÖÈ°µ ----- */
        .wechat-subpage {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #ededed;
            z-index: 100;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .wechat-subpage.active { transform: translateX(0); }

        .chat-header {
            height: 90px;
            padding: 45px 15px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ededed;
            border-bottom: 1px solid #dcdcdc;
        }
        .chat-back { font-size: 16px; cursor: pointer; padding: 5px; display: flex; align-items: center; }
        .chat-back svg { width: 20px; height: 20px; fill: #000; margin-right: 5px; }
        .chat-title { font-size: 17px; font-weight: 600; }
        .chat-menu { width: 30px; display: flex; justify-content: flex-end; }
        
        .chat-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .chat-msg-row { display: flex; align-items: flex-start; gap: 10px; }
        .chat-msg-row.self { flex-direction: row-reverse; }
        
        .chat-avatar { width: 40px; height: 40px; border-radius: 4px; background: #ddd; flex-shrink: 0; display:flex; justify-content:center; align-items:center; color:white; overflow:hidden;}
        .chat-avatar img { width: 100%; height: 100%; }
        
        .chat-msg-content { display: flex; flex-direction: column; align-items: flex-start; max-width: 70%; }
        .chat-msg-row.self .chat-msg-content { align-items: flex-end; }
        
        .chat-msg-name { font-size: 12px; color: #888; margin-bottom: 4px; margin-left: 2px; display: none; }
        
        .chat-bubble {
            padding: 10px 12px;
            border-radius: 4px;
            font-size: 16px;
            line-height: 1.4;
            position: relative;
        }
        .chat-msg-row:not(.self) .chat-bubble {
            background: #fff;
            color: #000;
        }
        .chat-msg-row:not(.self) .chat-bubble::before {
            content: "";
            position: absolute; top: 14px; left: -6px;
            width: 0; height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 6px solid #fff;
        }
        
        .chat-msg-row.self .chat-bubble {
            background: #95ec69;
            color: #000;
        }
        .chat-msg-row.self .chat-bubble::before {
            content: "";
            position: absolute; top: 14px; right: -6px;
            width: 0; height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 6px solid #95ec69;
        }

        .chat-footer {
            min-height: 60px;
            background: #f7f7f7;
            border-top: 1px solid #dcdcdc;
            padding: 10px;
            padding-bottom: 30px; /* ÈÄÇÈÖç Home Indicator */
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chat-input {
            flex-grow: 1;
            height: 36px;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 16px;
            outline: none;
            background: #fff;
        }
        .chat-btn { width: 28px; height: 28px; border: 1px solid #7f8389; border-radius: 50%; display: flex; justify-content: center; align-items: center;}
        .chat-send-btn { color: #fff; background: #07C160; border: none; padding: 6px 12px; border-radius: 4px; font-size: 14px; cursor: pointer; }


        /* ----- Êñ∞Âª∫/ÁºñËæëÂ§áÂøòÂΩïÂºπÁ™ó ----- */
        #memo-create-modal {
            position: absolute;
            bottom: -100%;
            left: 20px; right: 20px;
            height: 90%;
            background: white;
            border-radius: 25px 25px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
            z-index: 200;
            display: flex;
            flex-direction: column;
            transition: bottom 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), height 0.4s;
            padding: 20px;
        }
        #memo-create-modal.active { bottom: 0; }
        #memo-create-modal.expanded { height: 95%; }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-btn { font-size: 16px; color: #dcb0ba; font-weight: 600; cursor: pointer; }
        
        .memo-input-title {
            font-size: 24px; font-weight: bold;
            border: none; outline: none;
            width: 100%; margin-bottom: 15px;
            font-family: inherit;
        }
        .memo-input-content-wrapper {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .memo-input-content {
            flex-grow: 1;
            border: none; outline: none;
            resize: none;
            font-size: 16px; line-height: 1.5;
            font-family: inherit; color: #333;
        }
        .expand-btn {
            position: absolute;
            bottom: 10px; right: 10px;
            width: 30px; height: 30px;
            background: #f0f0f0;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #999;
            cursor: pointer;
        }

        /* ËèúÂçïÊ†∑Âºè */
        #context-menu, #settings-menu {
            position: absolute;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 5px;
            display: none;
            z-index: 300;
            min-width: 160px;
        }
        #settings-menu {
            top: 90px;
            right: 20px;
            transform-origin: top right;
            animation: menuPop 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        @keyframes menuPop {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .menu-item {
            padding: 12px 15px;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #eee;
        }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:active { background: #f5f5f5; border-radius: 8px; }
        .menu-item.danger { color: #ff3b30; }

        /* ÂºπÁ™óÊèêÈÜí */
        .toast {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 500;
        }
        .toast.show { opacity: 1; }

        /* iOS È£éÊ†ºÂºπÁ™ó */
        .ios-modal-mask {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .ios-modal-mask.active { display: flex; opacity: 1; }

        .ios-modal {
            width: 270px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            text-align: center;
            transform: scale(1.1);
            transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .ios-modal-mask.active .ios-modal { transform: scale(1); }

        .ios-modal-content {
            padding: 20px;
        }
        .ios-modal-title { font-size: 17px; font-weight: 600; margin-bottom: 5px; color: #000; }
        .ios-modal-desc { font-size: 13px; color: #000; }

        .ios-modal-actions {
            border-top: 1px solid rgba(0,0,0,0.15);
            display: flex;
            flex-direction: row;
        }
        .ios-modal-btn {
            flex: 1;
            padding: 12px;
            font-size: 17px;
            color: #007aff;
            background: transparent;
            border: none;
            cursor: pointer;
            border-right: 1px solid rgba(0,0,0,0.15);
        }
        .ios-modal-btn:last-child { border-right: none; }
        .ios-modal-btn:active { background: rgba(0,0,0,0.05); }
        .ios-modal-btn.bold { font-weight: 600; }

        /* iOS ÂºÄÂÖ≥Ê†∑Âºè */
        .ios-switch {
            position: relative;
            width: 50px;
            height: 30px;
            appearance: none;
            -webkit-appearance: none;
            background: #e9e9ea;
            outline: none;
            border-radius: 15px;
            transition: 0.3s;
            cursor: pointer;
        }
        .ios-switch:checked { background: #34c759; }
        .ios-switch::after {
            content: "";
            position: absolute;
            top: 2px; left: 2px;
            width: 26px; height: 26px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: 0.3s;
        }
        .ios-switch:checked::after { transform: translateX(20px); }

        /* ÁΩÆÈ°∂Ê∂àÊÅØÊ†∑Âºè */
        .wechat-item.pinned { background-color: #f7f7f7; }

        /* ËÆ∞ÂøÜÊëòË¶ÅÊù° */
        #memory-bar {
            position: absolute;
            top: 90px; /* Header height */
            left: 0; right: 0;
            height: 32px;
            background: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(5px);
            display: none; /* ÊúâÊï∞ÊçÆÊó∂ÊòæÁ§∫ */
            justify-content: center;
            align-items: center;
            font-size: 12px;
            color: #576b95;
            z-index: 90;
            cursor: pointer;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        #memory-bar:hover { background: rgba(247, 247, 247, 1); }
        
        /* ËÆ∞ÂøÜÂàóË°®ÊÇ¨ÊµÆÁ™ó */
        #memory-list-panel {
            position: absolute;
            top: 122px; /* 90 + 32 */
            right: 10px;
            width: 260px;
            max-height: 350px;
            background: rgba(255,255,255,0.98);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-radius: 8px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            z-index: 95;
            font-size: 12px;
            color: #333;
            animation: fadeIn 0.2s ease;
        }
        #memory-list-panel.active { display: flex; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .memory-item {
            padding: 8px 10px;
            background: #fcfcfc;
            border-radius: 6px;
            border: 1px solid #eee;
            border-left: 3px solid #07C160;
            display: flex;
            flex-direction: column;
            gap: 6px;
            position: relative;
        }
        .memory-header { display: flex; justify-content: space-between; align-items: center; }
        .memory-time { font-size: 10px; color: #999; }
        .memory-actions { display: flex; gap: 8px; opacity: 0.6; }
        .memory-action-btn { cursor: pointer; font-size: 14px; }
        .memory-action-btn:hover { opacity: 1; transform: scale(1.1); }
        
        .memory-text { line-height: 1.4; white-space: pre-wrap; }
        .memory-textarea {
            width: 100%;
            height: 80px;
            padding: 5px;
            border: 1px solid #07C160;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
            outline: none;
            margin-bottom: 5px;
        }
        .memory-edit-footer { display: flex; justify-content: flex-end; gap: 8px; }
        .memory-btn-sm {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            border: 1px solid #ccc;
        }
        .memory-btn-save { background: #07C160; color: white; border-color: #07C160; }

        .memory-add-btn {
            text-align: center;
            padding: 8px;
            background: #f0f9eb;
            color: #07C160;
            border: 1px dashed #07C160;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-bottom: 10px;
        }
        .memory-add-btn:active { background: #e1f3d8; }

        /* ÈìæÊé•Ê∞îÊ≥°Ê†∑Âºè */
        .chat-link-card {
            width: 240px;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .link-card-title {
            font-size: 16px;
            color: #000;
            margin: 10px 12px 6px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .link-card-content {
            display: flex;
            padding: 0 12px 10px;
            gap: 10px;
        }
        .link-card-desc {
            font-size: 12px;
            color: #888;
            line-height: 1.5;
            flex-grow: 1;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .link-card-thumb {
            width: 50px;
            height: 50px;
            background: #eee;
            flex-shrink: 0;
            object-fit: cover;
        }
        .link-card-footer {
            padding: 5px 12px;
            font-size: 10px;
            color: #aaa;
            border-top: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .chat-msg-row:not(.self) .chat-link-card { border: 1px solid #e5e5e5; }
        .chat-msg-row.self .chat-link-card { border: 1px solid #89d961; }
        
        /* ÈìæÊé•ËØªÂèñ/ÁîüÊàêÂºπÁ™ó */
        #link-input-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 2500;
            display: none; justify-content: center; align-items: center;
        }
        #link-input-modal.active { display: flex; }
        .link-modal-box {
            width: 300px; background: #fff; border-radius: 12px; overflow: hidden;
            display: flex; flex-direction: column; padding: 20px; gap: 15px;
        }
        .link-modal-title { font-size: 17px; font-weight: 600; text-align: center; }
        .link-input-row { display: flex; flex-direction: column; gap: 5px; }
        .link-label { font-size: 12px; color: #888; }
        .link-input { 
            padding: 8px; border: 1px solid #ddd; border-radius: 6px; 
            font-size: 14px; outline: none; transition: border-color 0.2s;
        }
        .link-input:focus { border-color: #07C160; }
        .link-btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .link-btn {
            flex: 1; padding: 10px; border-radius: 6px; text-align: center; font-size: 15px; cursor: pointer;
        }
        .link-btn.cancel { background: #f0f0f0; color: #666; }
        .link-btn.confirm { background: #07C160; color: white; }
        .link-preview-loading {
            font-size: 12px; color: #07C160; text-align: center; display: none;
        }

        /* ÈìæÊé•ËØ¶ÊÉÖÈ¢ÑËßàÁ™óÂè£ */
        #link-preview-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 2600;
            display: none; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #link-preview-modal.active { transform: translateY(0); display: flex; }
        
        .lp-header {
            height: 50px; border-bottom: 1px solid #eee; display: flex; align-items: center;
            padding: 0 15px; flex-shrink: 0;
        }
        .lp-close { font-size: 24px; color: #000; cursor: pointer; }
        .lp-title { flex-grow: 1; text-align: center; font-weight: 600; font-size: 17px; margin: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .lp-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .lp-article-title { font-size: 22px; font-weight: bold; margin-bottom: 10px; line-height: 1.4; }
        .lp-meta { font-size: 13px; color: #999; margin-bottom: 20px; }
        .lp-text { font-size: 16px; line-height: 1.6; color: #333; }
        .lp-img { width: 100%; border-radius: 8px; margin: 15px 0; }

    </style>
</head>
<body>

    <div class="phone-screen" id="phoneScreen">
        
        <!-- ÂÖ®Â±Ä Home Indicator (ÁÇπÂáªËøîÂõûÊ°åÈù¢) -->
        <div class="home-indicator-area" onclick="showDesktop()">
            <div class="home-indicator"></div>
        </div>

        <!-- Ê°åÈù¢Â±Ç -->
        <div id="desktop">
            <!-- È°∂ÈÉ®ÊØõÁéªÁíÉÂç°Áâá -->
            <div class="glass-card">
                <div class="avatar-wrapper" onclick="document.getElementById('avatarInput').click()">
                    <div class="avatar-circle" id="avatarPreview">
                        <span>Â§¥ÂÉè</span>
                    </div>
                    <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="previewAvatar(this)">
                </div>
                <div class="input-group">
                    <input type="text" class="custom-input" placeholder="ËæìÂÖ•ÂÜÖÂÆπ...">
                    <input type="text" class="custom-input" placeholder="ËæìÂÖ•ÂÜÖÂÆπ...">
                    <input type="text" class="custom-input" placeholder="ËæìÂÖ•ÂÜÖÂÆπ...">
                </div>
            </div>

            <!-- ‰∏≠ÈÉ®Âå∫Âüü -->
            <div class="middle-section">
                <!-- Â§áÂøòÂΩïÂ∞èÁªÑ‰ª∂ -->
                <div class="widget-memo" id="desktopWidget" onclick="openMemoApp()">
                    <div class="widget-memo-content-layer">
                        <div class="widget-memo-title">üìù Â§áÂøòÂΩï</div>
                    </div>
                </div>

                <!-- App ÁΩëÊ†º -->
                <div class="app-grid-2x2">
                    <div class="app-item" onclick="openWeChatApp()">
                        <div class="app-icon icon-wechat">
                            <div class="badge">12</div>
                            <svg viewBox="0 0 24 24"><path d="M17.5,10c0-2.5-2.2-4.5-5-4.5c-2.8,0-5,2-5,4.5c0,2.5,2.2,4.5,5,4.5c0.6,0,1.2-0.1,1.7-0.3 l3.2,1.7l-0.8-2.6C17.2,12.5,17.5,11.3,17.5,10z"/><path d="M7.7,14c-0.3,0-0.7,0-1,0.1L4.3,13l0.5,1.7C3.5,15.6,2.7,16.7,2.7,18c0,2.1,2.1,3.8,4.7,3.8 c0.5,0,1-0.1,1.5-0.2l2.3,1.2l-0.6-1.9c1-0.7,1.6-1.7,1.6-2.9C12.2,15.9,10.2,14,7.7,14z"/></svg>
                        </div>
                        <span class="app-name">ÂæÆ‰ø°</span>
                    </div>
                    <div class="app-item">
                        <div class="app-icon icon-worldbook">
                            <svg viewBox="0 0 24 24"><path d="M18,2H6C4.9,2,4,2.9,4,4v16c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2V4C20,2.9,19.1,2,18,2z M12,18 c-2.2,0-4-1.8-4-4s1.8-4,4-4s4,1.8,4,4S14.2,18,12,18z"/><rect x="6" y="4" width="12" height="2" fill="rgba(255,255,255,0.5)"/></svg>
                        </div>
                        <span class="app-name">‰∏ñÁïå‰π¶</span>
                    </div>
                    <div class="app-item"><div class="app-icon icon-placeholder empty"></div><span class="app-name"></span></div>
                    <div class="app-item"><div class="app-icon icon-placeholder empty"></div><span class="app-name"></span></div>
                </div>
            </div>

            <!-- Dock Ê†è -->
            <div class="dock-bar">
                <div class="app-item" onclick="openSettingsApp()">
                    <div class="app-icon icon-settings-app">
                        <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.43-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.49-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
                    </div>
                    <span class="app-name">ËÆæÁΩÆ</span>
                </div>
                <div class="app-item">
                    <div class="app-icon icon-themes">
                        <svg viewBox="0 0 24 24"><path d="M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9c0.83,0,1.5-0.67,1.5-1.5c0-0.39-0.15-0.74-0.39-1.01c-0.23-0.26-0.38-0.61-0.38-0.99 c0-0.83,0.67-1.5,1.5-1.5H16c2.76,0,5-2.24,5-5C21,6.58,16.97,3,12,3z M6.5,12c-0.83,0-1.5-0.67-1.5-1.5S5.67,9,6.5,9 S8,9.67,8,10.5S7.33,12,6.5,12z M9.5,8C8.67,8,8,7.33,8,6.5S8.67,5,9.5,5S11,5.67,11,6.5S10.33,8,9.5,8z M14.5,8 c-0.83,0-1.5-0.67-1.5-1.5S13.67,5,14.5,5S16,5.67,16,6.5S15.33,8,14.5,8z M17.5,12c-0.83,0-1.5-0.67-1.5-1.5S16.67,9,17.5,9 S19,9.67,19,10.5S18.33,12,17.5,12z"/></svg>
                    </div>
                    <span class="app-name">‰∏ªÈ¢ò</span>
                </div>
                <div class="app-item"><div class="app-icon icon-placeholder empty"></div><span class="app-name"></span></div>
            </div>
        </div>

        <!-- Â§áÂøòÂΩï App -->
        <div id="memo-app" class="app-container">
            <div class="app-header">
                <div class="header-btn" onclick="showDesktop()">‚ùÆ ËøîÂõû</div>
                <div class="header-title">Â§áÂøòÂΩï</div>
                <div class="header-btn" onclick="openMemoSettings(event)">
                    <svg style="width:24px;height:24px;fill:#dcb0ba;" viewBox="0 0 24 24">
                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                    </svg>
                </div>
            </div>
            <div class="memo-list" id="memoList"></div>
            <div class="app-footer" id="appFooter">
                <div class="create-memo-btn" onclick="openMemoModal()">
                    <svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white;margin-right:5px;"><path d="M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04Z"/></svg>
                </div>
                <div class="selection-footer">
                    <div onclick="selectAllMemos()">ÂÖ®ÈÄâ</div>
                    <div style="color: #ff3b30;" onclick="deleteSelectedMemos()">Âà†Èô§</div>
                    <div onclick="exitSelectionMode()">ÂèñÊ∂à</div>
                </div>
            </div>
            <!-- ËÆæÁΩÆËèúÂçï -->
            <div id="settings-menu">
                <div class="menu-item" onclick="handleSettingsAction('bg')">Êõ¥Êç¢Ê°åÈù¢ÁÖßÁâá</div>
                <div class="menu-item" onclick="handleSettingsAction('manage')">ÈÄâÊã©Â§áÂøòÂΩï</div>
            </div>
        </div>

        <!-- ËÆæÁΩÆ App -->
        <div id="settings-app" class="app-container">
            <div class="app-header">
                <div class="header-btn" onclick="showDesktop()">‚ùÆ ËøîÂõû</div>
                <div class="header-title">ËÆæÁΩÆ</div>
                <div class="header-btn" style="color: #007aff; font-weight: 600;" onclick="saveApiSettings()">‰øùÂ≠ò</div>
            </div>
            <div style="flex-grow: 1; overflow-y: auto; padding-top: 10px;">
                <div style="padding-left: 20px; margin-bottom: 5px; font-size: 13px; color: #6d6d72; text-transform: uppercase;">AI Êé•Âè£ËøûÊé•</div>
                <div class="settings-group" style="margin-top: 0;">
                    <div class="settings-row">
                        <div class="settings-label">Êé•Âè£Âú∞ÂùÄ</div>
                        <input type="text" id="apiEndpoint" class="settings-input" placeholder="https://api.openai.com/v1">
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">API Key</div>
                        <input type="password" id="apiKey" class="settings-input" placeholder="sk-...">
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">Ê®°ÂûãÂêçÁß∞</div>
                        <input type="text" id="apiModel" class="settings-input" placeholder="gpt-3.5-turbo">
                    </div>
                    <div class="settings-row" onclick="fetchModelList()" style="cursor: pointer; justify-content: center;">
                        <span style="color: #007aff; font-size: 15px;">‰ªéÊúçÂä°Âô®ÊãâÂèñÊ®°ÂûãÂàóË°®</span>
                    </div>
                </div>
                <div style="padding: 10px 20px; font-size: 13px; color: #8e8e93;">
                    ËÆæÁΩÆÂÖºÂÆπ OpenAI Ê†ºÂºèÁöÑÊé•Âè£‰ø°ÊÅØ„ÄÇ‰øùÂ≠òÂêéÔºåËÅäÂ§©ÂõûÂ§çÂ∞ÜÂ∞ùËØïÈÄöËøáËØ•Êé•Âè£ËØ∑Ê±Ç„ÄÇ
                </div>
            </div>
        </div>

        <!-- ÂæÆ‰ø° App -->
        <div id="wechat-app" class="app-container">
            <div class="wechat-pages">
                <!-- ÂæÆ‰ø° Tab (È¶ñÈ°µ) -->
                <div id="tab-chat" class="wechat-page active">
                    <div class="wechat-header">
                        <div class="wechat-back-btn" onclick="showDesktop()">‚ùÆ</div>
                        <div class="wechat-title">ÂæÆ‰ø°(12)</div>
                        <div class="wechat-header-icons">
                            <svg class="wechat-icon" viewBox="0 0 24 24"><path d="M15.5,14h-0.79l-0.28-0.27C15.41,12.59,16,11.11,16,9.5C16,5.91,13.09,3,9.5,3S3,5.91,3,9.5S5.91,16,9.5,16c1.61,0,3.09-0.59,4.23-1.57l0.27,0.28v0.79l5,4.99L20.49,19L15.5,14z M9.5,14C7.01,14,5,11.99,5,9.5S7.01,5,9.5,5S14,7.01,14,9.5S11.99,14,9.5,14z"/></svg>
                            <div onclick="toggleWeChatMenu(event)" style="display:flex;">
                                <svg class="wechat-icon" viewBox="0 0 24 24"><path d="M19,13h-6v6h-2v-6H5v-2h6V5h2v6h6V13z"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="wechat-list" id="wechat-chat-list">
                        <!-- Âä®ÊÄÅÊ∏≤Êüì -->
                    </div>
                </div>

                <!-- ÈÄöËÆØÂΩï Tab -->
                <div id="tab-contact" class="wechat-page">
                    <div class="wechat-header">
                        <div class="wechat-back-btn" onclick="showDesktop()">‚ùÆ</div>
                        <div class="wechat-title">ÈÄöËÆØÂΩï</div>
                        <div class="wechat-header-icons"><svg class="wechat-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg></div>
                    </div>
                    <div class="wechat-list">
                        <!-- Â•ΩÂèãÂàóË°® -->
                        <div style="padding:10px 15px; color:#888; font-size:14px; background:#ededed;">Â•ΩÂèã</div>
                        <div class="wechat-cell-group" id="contact-list-friends" style="margin-top:0;">
                            <!-- Âä®ÊÄÅÊ∏≤ÊüìÂ•ΩÂèã -->
                        </div>

                        <!-- Áæ§ËÅäÂàóË°® -->
                        <div style="padding:10px 15px; color:#888; font-size:14px; background:#ededed;">Áæ§ËÅä</div>
                        <div class="wechat-cell-group" id="contact-list-groups" style="margin-top:0;">
                            <!-- Âä®ÊÄÅÊ∏≤ÊüìÁæ§ËÅä -->
                        </div>
                    </div>
                </div>

                <!-- ÂèëÁé∞ Tab -->
                <div id="tab-discover" class="wechat-page">
                    <div class="wechat-header">
                        <div class="wechat-back-btn" onclick="showDesktop()">‚ùÆ</div>
                        <div class="wechat-title">ÂèëÁé∞</div>
                    </div>
                    <div class="wechat-list">
                        <div class="wechat-cell-group">
                            <div class="wechat-cell">
                                <img src="https://api.iconify.design/mdi:camera-iris.svg" class="wechat-cell-icon">
                                <div class="wechat-cell-text">ÊúãÂèãÂúà</div>
                                <div class="wechat-cell-arrow"></div>
                            </div>
                        </div>
                        <div class="wechat-cell-group">
                            <div class="wechat-cell">
                                <img src="https://api.iconify.design/mdi:shopping-outline.svg" class="wechat-cell-icon">
                                <div class="wechat-cell-text">Ë¥≠Áâ©</div>
                                <div class="wechat-cell-arrow"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Êàë Tab -->
                <div id="tab-me" class="wechat-page">
                    <div style="background:#fff; padding-top:45px;">
                        <div class="wechat-header" style="background:#fff; border:none; height:45px; padding:0 15px;">
                             <div class="wechat-back-btn" onclick="showDesktop()">‚ùÆ</div>
                        </div>
                    </div>
                    <div style="padding: 10px 20px 30px; background:#fff; display:flex; gap:20px; align-items:center; margin-bottom:10px;">
                        <div style="width:64px; height:64px; border-radius:8px; background:#eee; overflow:hidden;">
                            <!-- Â§¥ÂÉèÂç†‰Ωç -->
                            <div style="width:100%;height:100%;background:url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23ddd%22/><text x=%2250%22 y=%2250%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23fff%22>Êàë</text></svg>') center/cover"></div>
                        </div>
                        <div>
                            <div style="font-size:20px; font-weight:bold; margin-bottom:5px;">Â∞èÈúÅ</div>
                            <div style="font-size:14px; color:#888;">ÂæÆ‰ø°Âè∑Ôºöxiaoji_phone</div>
                        </div>
                        <div style="margin-left:auto;"><svg width="20" height="20" viewBox="0 0 24 24"><path d="M4 15h16v-2H4v2zm0 4h16v-2H4v2zm0-8h16V9H4v2zm0-6v2h16V5H4z" fill="#ccc"/></svg></div>
                    </div>
                    
                    <div class="wechat-cell-group">
                        <div class="wechat-cell">
                            <img src="https://api.iconify.design/mdi:cube-outline.svg" class="wechat-cell-icon">
                            <div class="wechat-cell-text">ÊúçÂä°</div>
                            <div class="wechat-cell-arrow"></div>
                        </div>
                    </div>
                    <div class="wechat-cell-group">
                        <div class="wechat-cell">
                            <img src="https://api.iconify.design/mdi:sticker-emoji.svg" class="wechat-cell-icon">
                            <div class="wechat-cell-text">Ë°®ÊÉÖ</div>
                            <div class="wechat-cell-arrow"></div>
                        </div>
                    </div>
                    <div class="wechat-cell-group">
                        <div class="wechat-cell">
                            <img src="https://api.iconify.design/mdi:cog-outline.svg" class="wechat-cell-icon">
                            <div class="wechat-cell-text">ËÆæÁΩÆ</div>
                            <div class="wechat-cell-arrow"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ËÅäÂ§©ËØ¶ÊÉÖÈ°µ (Ë¶ÜÁõñÂú® Tab È°µ‰πã‰∏ä) -->
            <div id="wechat-chat-detail" class="wechat-subpage">
                <div class="chat-header">
                    <div class="chat-back" onclick="closeChatDetail()">
                        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                        ÂæÆ‰ø°(12)
                    </div>
                    <div class="chat-title" id="chatTitle">Áî®Êà∑</div>
                    <div class="chat-menu" onclick="openChatSettings()">...</div>
                </div>
                <!-- ËÆ∞ÂøÜÊëòË¶ÅÊù° -->
                <div id="memory-bar" onclick="toggleMemoryPanel()">
                    <span>‚ú® Â≠òÂú® 0 Êù°ËÆ∞ÂøÜÊëòË¶ÅÔºåÁÇπÂáªÊü•Áúã</span>
                </div>
                <!-- ËÆ∞ÂøÜÂàóË°®Èù¢Êùø -->
                <div id="memory-list-panel">
                    <!-- Âä®ÊÄÅÁîüÊàê -->
                </div>

                <div class="chat-body" id="chatBody">
                    <!-- Âä®ÊÄÅÁîüÊàêÊ∂àÊÅØ -->
                </div>
                <div class="chat-footer">
                    <!-- ÈáçÊñ∞ÂõûÂ§ç -->
                    <div class="chat-btn" onclick="triggerAIResponse(true)" title="ËÆ©AIÈáçÊñ∞ÂõûÂ§ç">
                        <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:#555"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-0.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14 0.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    </div>
                    <input type="text" class="chat-input" id="chatInput" placeholder="">
                    <!-- Ëß¶ÂèëÂõûÂ§ç -->
                    <div class="chat-btn" onclick="triggerAIResponse(false)" title="ËÆ©AIÂõûÂ§ç">
                        <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:#555"><path d="M20,2H4C2.9,2 2,2.9 2,4V22L6,18H20C21.1,18 22,17.1 22,16V4C22,2.9 21.1,2 20,2M20,16H5.17L4,17.17V4H20V16Z" /></svg>
                    </div>
                    <button class="chat-send-btn" onclick="sendChatMessage()">ÂèëÈÄÅ</button>
                </div>
            </div>

            <div class="wechat-tabbar">
                <div class="wechat-tab active" onclick="switchWeChatTab(0)">
                    <svg class="wechat-tab-icon" viewBox="0 0 24 24"><path d="M21.58,16.09l-1.09-3.29C20.45,12.65,20.4,12.32,20.35,12c0-3.31-3.13-6-7-6c-3.87,0-7,2.69-7,6c0,3.31,3.13,6,7,6 c0.73,0,1.43-0.09,2.11-0.27l3.86,2.05C19.7,19.98,20.17,19.77,20.32,19.26C20.39,19.03,20.38,18.78,20.28,18.56L21.58,16.09z M6,12 c0-4.42,4.03-8,9-8c4.97,0,9,3.58,9,8c0,1.48-0.45,2.87-1.25,4.08l1.45,2.75C24.46,19.34,24.47,20,24.22,20.59 c-0.49,1.14-1.8,1.67-2.94,1.18l-3.32-1.76C16.89,20.67,15.47,21,14,21C8.48,21,4,16.97,4,12H6z M4.93,12.59l-2.02,2.02 C2.74,14.78,2.78,15.05,3,15.19l1.79,1.16c-0.23,0.59-0.38,1.21-0.42,1.86l-2.11,0.43c-0.24,0.05-0.41,0.26-0.41,0.51V20.8 c0,0.28,0.22,0.5,0.5,0.5h1.66c0.05,0.65,0.21,1.27,0.46,1.85L2.69,24.31c-0.12,0.22-0.07,0.49-0.12,0.61l1.44,0.83 c0.22,0.12,0.49,0.07,0.61-0.12l1.04-1.8c0.59,0.23,1.21,0.38,1.86,0.42l0.43,2.11c0.05,0.24,0.26,0.41,0.51,0.41h1.66 c0.28,0,0.5-0.22,0.5-0.5v-1.66c0.65-0.05,1.27-0.21,1.85-0.46l1.16,1.79c0.14,0.22,0.41,0.26,0.61,0.12l1.44-0.83 c0.22-0.12,0.26-0.39,0.12-0.61l-1.04-1.8c0.23-0.59,0.38-1.21,0.42-1.86l2.11-0.43c0.24-0.05,0.41-0.26,0.41-0.51v-1.66 c0-0.28-0.22-0.5-0.5-0.5h-1.66c-0.05-0.65-0.21-1.27-0.46-1.85l1.79-1.16c0.22-0.14,0.26-0.41,0.12-0.61l-0.83-1.44 c-0.12-0.22-0.39-0.26-0.61-0.12l-1.8,1.04C15.86,13.23,15.24,13.08,14.59,13.04z"/></svg>
                    <span class="wechat-tab-label">ÂæÆ‰ø°</span>
                </div>
                <div class="wechat-tab" onclick="switchWeChatTab(1)">
                    <svg class="wechat-tab-icon" viewBox="0 0 24 24"><path d="M4,18v-0.65c0-1.78,3.58-2.67,5.33-2.67s5.33,0.89,5.33,2.67V18H4z M9.33,12.67c-1.47,0-2.67-1.19-2.67-2.67 s1.19-2.67,2.67-2.67s2.67,1.19,2.67,2.67S10.8,12.67,9.33,12.67z M18.67,15.78c-0.22-0.12-0.48-0.07-0.61,0.12 c-0.35,0.61-0.97,1.03-1.72,1.1c0.63-0.87,1-1.92,1-3.04v-0.65c0-0.29-0.09-0.56-0.24-0.8c0.82-0.68,1.35-1.69,1.35-2.84 c0-1.74-1.2-3.2-2.82-3.64c0.01-0.12,0.02-0.23,0.02-0.35c0-2.58-2.09-4.67-4.67-4.67S6.33,3.09,6.33,5.67c0,0.12,0.01,0.23,0.02,0.35 C4.73,6.47,3.53,7.93,3.53,9.67c0,1.15,0.53,2.16,1.35,2.84c-0.15,0.23-0.24,0.51-0.24,0.8v0.65c0,1.12,0.37,2.16,1,3.04 c-0.75-0.07-1.37-0.49-1.72-1.1c-0.12-0.22-0.39-0.26-0.61-0.12l-1.44,0.83C1.65,16.73,1.6,17,1.72,17.22l2.67,4.62 C4.58,22.17,4.92,22.33,5.25,22.33c0.16,0,0.31-0.04,0.46-0.12l1.62-0.93c1.23,0.47,2.57,0.72,3.97,0.72h0.07 c1.4-0.01,2.74-0.26,3.96-0.73l1.62,0.93c0.14,0.08,0.3,0.12,0.46,0.12c0.34,0,0.67-0.16,0.86-0.48l2.67-4.62 c0.12-0.22,0.07-0.49-0.12-0.61L18.67,15.78z"/></svg>
                    <span class="wechat-tab-label">ÈÄöËÆØÂΩï</span>
                </div>
                <div class="wechat-tab" onclick="switchWeChatTab(2)">
                    <svg class="wechat-tab-icon" viewBox="0 0 24 24"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,17.93c-3.27,0-5.93-2.66-5.93-5.93 S8.73,6.07,12,6.07s5.93,2.66,5.93,5.93S15.27,17.93,12,17.93z M14.19,13.34l-3.32-1.76l-0.68,1.29l3.32,1.76 C13.72,14.74,13.97,14.53,14.19,13.34z M10.6,10.15l1.52-2.87l-1.32-0.7L9.28,9.45C9.76,9.59,10.21,9.83,10.6,10.15z"/></svg>
                    <span class="wechat-tab-label">ÂèëÁé∞</span>
                </div>
                <div class="wechat-tab" onclick="switchWeChatTab(3)">
                    <svg class="wechat-tab-icon" viewBox="0 0 24 24"><path d="M12,12c2.21,0,4-1.79,4-4s-1.79-4-4-4S8,5.79,8,8S9.79,12,12,12z M12,14c-2.67,0-8,1.34-8,4v2h16v-2C20,15.34,14.67,14,12,14z"/></svg>
                    <span class="wechat-tab-label">Êàë</span>
                </div>
            </div>
        </div>

        <!-- Êñ∞Âª∫/ÁºñËæëÂ§áÂøòÂΩïÂºπÁ™ó -->
        <div id="memo-create-modal">
            <div class="modal-header">
                <div class="modal-btn" style="color: #666;" onclick="tryCloseCreateModal()">ÂÖ≥Èó≠</div>
                <div class="modal-btn" onclick="saveMemo()">ÂÆåÊàê</div>
            </div>
            <input type="text" class="memo-input-title" id="newMemoTitle" placeholder="Ê†áÈ¢ò">
            <div class="memo-input-content-wrapper">
                <textarea class="memo-input-content" id="newMemoContent" placeholder="ÂÜÖÂÆπ..."></textarea>
                <div class="expand-btn" onclick="toggleExpandModal()">
                    <svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:#666;"><path d="M12,18.17L8.83,15L7.42,16.41L12,21L16.59,16.41L15.17,15M12,5.83L15.17,9L16.58,7.59L12,3L7.41,7.59L8.83,9L12,5.83Z"/></svg>
                </div>
            </div>
        </div>

        <!-- ÈïøÊåâËèúÂçï -->
        <div id="context-menu">
            <div class="menu-item" onclick="handleMenuAction('pin')">ÁΩÆÈ°∂</div>
            <div class="menu-item danger" onclick="handleMenuAction('delete')">Âà†Èô§</div>
        </div>

        <!-- ÂæÆ‰ø°Âè≥‰∏äËßíËèúÂçï -->
        <div id="wechat-plus-menu">
            <div class="wechat-menu-item" onclick="showGroupCreateModal()">
                <svg class="wechat-menu-icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM4 18v-3h2v3H4zm14 0h-9v-2h9v2zm0-4h-9v-2h9v2zm0-4H6V8h12v2z"/></svg>
                ÂèëËµ∑Áæ§ËÅä
            </div>
            <div class="wechat-menu-item" onclick="showWeChatInputModal()">
                <svg class="wechat-menu-icon" viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                Ê∑ªÂä†ÊúãÂèã
            </div>
            <div class="wechat-menu-item" onclick="showWeChatInputModal()">
                <svg class="wechat-menu-icon" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/></svg>
                ÂàõÂª∫Êñ∞ËÅäÂ§©
            </div>
            <div class="wechat-menu-item" onclick="showLinkInputModal()">
                <svg class="wechat-menu-icon" viewBox="0 0 24 24"><path d="M3.9,12c0-1.71,1.39-3.1,3.1-3.1h4V7H7c-2.76,0-5,2.24-5,5s2.24,5,5,5h4v-1.9H7C5.29,15.1,3.9,13.71,3.9,12z M8,13h8v-2H8V13z M17,7h-4v1.9h4c1.71,0,3.1,1.39,3.1,3.1s-1.39,3.1-3.1,3.1h-4V17h4c2.76,0,5-2.24,5-5S20.76,7,17,7z"/></svg>
                ÂèëÈÄÅÈìæÊé•Âç°Áâá
            </div>
        </div>

        <!-- ÈìæÊé•ËæìÂÖ•/È¢ÑËßàÊ®°Âùó -->
        <div id="link-input-modal">
            <div class="link-modal-box">
                <div class="link-modal-title">ÂèëÈÄÅÈìæÊé•</div>
                
                <div class="link-input-row">
                    <span class="link-label">ÈìæÊé• URL</span>
                    <input type="text" class="link-input" id="linkUrl" placeholder="https://..." onblur="simulateLinkPreview()">
                </div>
                
                <div class="link-preview-loading" id="linkLoading">Ê≠£Âú®ËØªÂèñÈìæÊé•ÂÜÖÂÆπ...</div>

                <div class="link-input-row">
                    <span class="link-label">Ê†áÈ¢ò</span>
                    <input type="text" class="link-input" id="linkTitle" placeholder="ËæìÂÖ•Ê†áÈ¢ò">
                </div>
                
                <div class="link-input-row">
                    <span class="link-label">ÊëòË¶Å</span>
                    <input type="text" class="link-input" id="linkDesc" placeholder="ËæìÂÖ•ÊëòË¶ÅÊèèËø∞">
                </div>

                <div class="link-input-row">
                    <span class="link-label">Â∞ÅÈù¢Âõæ URL (ÂèØÈÄâ)</span>
                    <input type="text" class="link-input" id="linkImg" placeholder="ÂõæÁâáÂú∞ÂùÄ">
                </div>

                <div class="link-btn-group">
                    <div class="link-btn cancel" onclick="closeLinkInputModal()">ÂèñÊ∂à</div>
                    <div class="link-btn confirm" onclick="sendLinkMessage()">ÂèëÈÄÅ</div>
                </div>
            </div>
        </div>

        <!-- ÈìæÊé•ËØ¶ÊÉÖÈ¢ÑËßàÁ™óÂè£ -->
        <div id="link-preview-modal">
            <div class="lp-header">
                <div class="lp-close" onclick="closeLinkPreview()">√ó</div>
                <div class="lp-title" id="lpHeaderTitle">ÁΩëÈ°µÊµèËßà</div>
                <div style="width:24px;"></div>
            </div>
            <div class="lp-content" id="lpContent">
                <!-- Âä®ÊÄÅÂ°´ÂÖÖ -->
            </div>
        </div>

        <!-- ÂæÆ‰ø°ËæìÂÖ•ÂºπÁ™ó -->
        <div id="wechat-input-modal-mask">
            <div class="wechat-input-box">
                <div class="wechat-input-header">ÂàõÂª∫Êñ∞ËÅäÂ§©</div>
                <div class="wechat-input-body">
                    <input type="text" class="wechat-name-input" id="wechatNewName" placeholder="ËæìÂÖ•ÂêçÂ≠ó">
                </div>
                <div class="wechat-input-footer">
                    <div class="wechat-input-btn cancel" onclick="closeWeChatInputModal()">ÂèñÊ∂à</div>
                    <div class="wechat-input-btn" onclick="confirmWeChatAdd()">Á°ÆÂÆö</div>
                </div>
            </div>
        </div>


        <!-- ÂèëËµ∑Áæ§ËÅäÈÄâÊã©È°µÈù¢ -->
        <div id="wechat-group-create-modal" class="wechat-subpage" style="z-index: 1500; background: #ededed;">
            <div class="wechat-header">
                <div class="wechat-back-btn" onclick="closeGroupCreateModal()" style="font-weight:400; font-size:16px;">ÂèñÊ∂à</div>
                <div class="wechat-title">ÂèëËµ∑Áæ§ËÅä</div>
                <div class="wechat-input-btn" style="width:auto; border:none; color:#ddd; font-weight:600; padding:0;" id="btnCreateGroup" onclick="createGroupChat()">ÂÆåÊàê</div>
            </div>
            <div class="wechat-list" id="group-contact-list" style="padding-top:10px;">
                <!-- Âä®ÊÄÅÊ∏≤ÊüìÂ•ΩÂèãÂàóË°® -->
            </div>
        </div>

        <!-- ËÅäÂ§©ËØ¶ÊÉÖËÆæÁΩÆÂºπÁ™ó -->
        <div id="wechat-settings-modal">
            <div class="ws-header">ËÅäÂ§©ËØ¶ÊÉÖ</div>
            <div class="ws-body">
                <div>
                    <div class="ws-section-title">Âü∫Á°ÄËµÑÊñô</div>
                    <div class="ws-card">
                        <div class="ws-row">
                            <div class="ws-label" id="labelFriendName">Â•ΩÂèãÂßìÂêç</div>
                            <input type="text" class="ws-input" id="wsFriendName" style="color:#333" placeholder="ËæìÂÖ•ÂßìÂêç">
                        </div>
                        <div class="ws-row">
                            <div class="ws-label">Â§áÊ≥®Âêç</div>
                            <input type="text" class="ws-input" id="wsRemark" placeholder="ÁÇπÂáªÊ∑ªÂä†Â§áÊ≥®">
                        </div>
                        <div class="ws-row" onclick="document.getElementById('wsAvatarInput').click()">
                            <div class="ws-label" id="labelFriendAvatar">Â•ΩÂèãÂ§¥ÂÉè</div>
                            <div class="ws-avatar-preview" id="wsFriendAvatar"></div>
                            <div style="color:#ccc;margin-left:5px;">‚Ä∫</div>
                        </div>
                        <div class="ws-row" onclick="document.getElementById('wsBgInput').click()">
                            <div class="ws-label">ËÅäÂ§©ËÉåÊôØ</div>
                            <div class="ws-avatar-preview" id="wsBgPreview" style="background:transparent;color:#999;font-size:12px;width:auto;">ÈªòËÆ§</div>
                            <div style="color:#ccc;margin-left:5px;">‚Ä∫</div>
                        </div>
                        <div class="ws-row" onclick="document.getElementById('wsMyAvatarInput').click()">
                            <div class="ws-label">ÊàëÁöÑÂ§¥ÂÉè</div>
                            <div class="ws-avatar-preview" id="wsMyAvatar" style="background:#eee;color:#333">ME</div>
                            <div style="color:#ccc;margin-left:5px;">‚Ä∫</div>
                        </div>
                        <div class="ws-row">
                            <div class="ws-label">ÁΩÆÈ°∂ËÅäÂ§©</div>
                            <div style="flex-grow:1; display:flex; justify-content:flex-end;">
                                <input type="checkbox" class="ios-switch" id="wsIsPinned">
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        <div class="ws-section-title" id="titleFriendPersona">Â•ΩÂèã‰∫∫ËÆæ</div>
                        <div class="ws-card">
                            <div style="padding:10px;">
                                <textarea class="ws-textarea" id="wsFriendPersona" placeholder="ËæìÂÖ•Â•ΩÂèã‰∫∫ËÆæÊèèËø∞..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        <div class="ws-section-title">ÊàëÁöÑ‰∫∫ËÆæ</div>
                        <div class="ws-card">
                            <div style="padding:10px;">
                                <textarea class="ws-textarea" id="wsMyPersona" placeholder="ËæìÂÖ•ÊàëÁöÑ‰∫∫ËÆæÊèèËø∞..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        <div class="ws-section-title">ËÆ∞ÂøÜËÆæÁΩÆ</div>
                        <div class="ws-card">
                            <div class="ws-row">
                                <div class="ws-label" style="width:120px;">Ëá™Âä®ÊÄªÁªìÈòàÂÄº</div>
                                <input type="number" class="ws-input" id="wsMemoryThreshold" placeholder="ÈªòËÆ§20Êù°" style="text-align:right;">
                                <div style="margin-left:5px;color:#999;">Êù°</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        <div class="ws-section-title" style="display:flex;justify-content:space-between;align-items:center;">
                            <span>ËÆ∞ÂøÜÊëòË¶ÅÁΩóÂàó</span>
                            <span style="color:#07C160;font-size:13px;cursor:pointer;padding:5px;" onclick="addManualMemoryFromSettings()">+ Ê∑ªÂä†</span>
                        </div>
                        <div class="ws-card" id="wsMemoryListContainer" style="min-height: 50px;">
                            <!-- Âä®ÊÄÅÊ∏≤ÊüìËÆ∞ÂøÜÈ°π -->
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        <div class="ws-section-title">Ê∞îÊ≥°Ê†∑ÂºèËá™ÂÆö‰πâ (CSS)</div>
                        <div class="ws-card" style="padding: 15px;">
                            <!-- Shadow DOM È¢ÑËßàÂÆπÂô® -->
                            <div id="wsBubblePreviewContainer" style="width:100%; height:120px; background:#ededed; border-radius:8px; margin-bottom:10px; border:1px solid #eee;"></div>
                            <textarea id="wsCustomCss" class="ws-textarea" placeholder="Âú®Ê≠§ËæìÂÖ• CSSÔºå‰æãÂ¶ÇÔºö&#10;.chat-bubble { background: pink; }&#10;.self .chat-bubble { background: skyblue; }" style="font-family: monospace; font-size: 12px; background: #f9f9f9; padding: 10px; border-radius: 6px; height: 100px;" oninput="updateBubblePreview()"></textarea>
                        </div>
                    </div>
                    <!-- ÈöêËóèÁöÑËÆæÁΩÆ Inputs -->
                    <input type="file" id="wsAvatarInput" accept="image/*" style="display:none" onchange="previewSettingsAvatar(this)">
                    <input type="file" id="wsBgInput" accept="image/*" style="display:none" onchange="previewSettingsBg(this)">
                    <input type="file" id="wsMyAvatarInput" accept="image/*" style="display:none" onchange="previewSettingsMyAvatar(this)">
                </div>


                <div style="margin-top: 20px;">
                    <div class="ws-card" onclick="deleteCurrentContact()">
                        <div class="ws-row" style="justify-content: center;">
                            <span style="color: #ff3b30; font-size: 17px; font-weight: 600;">Âà†Èô§ËÅîÁ≥ª‰∫∫</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ws-footer">
                <div class="ws-btn back" onclick="closeChatSettings()">ËøîÂõû</div>
                <div class="ws-btn cancel" onclick="closeChatSettings()">ÂèñÊ∂à</div>
                <div class="ws-btn save" onclick="saveChatSettings()">‰øùÂ≠ò</div>
            </div>
        </div>

        <!-- ÂºπÁ™óÊèêÈÜí -->
        <div class="toast" id="toast">Êìç‰ΩúÊàêÂäü</div>

        <!-- iOS È£éÊ†ºÂºπÁ™ó -->
        <div class="ios-modal-mask" id="iosModal">
            <div class="ios-modal">
                <div class="ios-modal-content">
                    <div class="ios-modal-title" id="iosModalTitle">Ê†áÈ¢ò</div>
                    <div class="ios-modal-desc" id="iosModalDesc">ÊèèËø∞ÂÜÖÂÆπ</div>
                </div>
                <div class="ios-modal-actions">
                    <div class="ios-modal-btn" id="iosModalCancelBtn" onclick="handleIOSDialog(false)">ÂèñÊ∂à</div>
                    <div class="ios-modal-btn bold" id="iosModalConfirmBtn" onclick="handleIOSDialog(true)">Á°ÆÂÆö</div>
                </div>
            </div>
        </div>

        <!-- ÈöêËóèÁöÑÂõæÁâá‰∏ä‰º† -->
        <input type="file" id="widgetBgInput" accept="image/*" style="display:none" onchange="updateWidgetBg(this)">

        <!-- Ê®°ÂûãÈÄâÊã©ÂºπÁ™ó -->
        <div class="ios-modal-mask" id="model-select-modal">
            <div class="ios-modal" style="width: 340px; height: 500px; text-align: left;">
                <div style="padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.8);">
                    <div style="font-size: 17px; font-weight: 600;">ÈÄâÊã©Ê®°Âûã</div>
                    <div style="color:#007aff; cursor:pointer; font-size: 16px;" onclick="closeModelModal()">ÂÖ≥Èó≠</div>
                </div>
                <div id="model-list-container" style="flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; background: rgba(255,255,255,0.5);">
                    <!-- Âä®ÊÄÅÂ°´ÂÖÖ -->
                </div>
            </div>
        </div>

    </div>

    <script>
        // Êï∞ÊçÆÂ≠òÂÇ®
        const defaultMemos = [
            { id: 1, title: 'Ë¥≠Áâ©Ê∏ÖÂçï', content: '1. ÁâõÂ•∂\n2. Èù¢ÂåÖ\n3. È∏°Ëõã', pinned: true, date: '2026/1/5' },
            { id: 2, title: '‰ºöËÆÆËÆ∞ÂΩï', content: '‰∏ãÂçà‰∏âÁÇπÈ°πÁõÆËøõÂ∫¶‰ºö', pinned: false, date: '2026/1/4' }
        ];
        // Â∞ùËØï‰ªé localStorage ËØªÂèñ
        let memos = JSON.parse(localStorage.getItem('ios_memos')) || defaultMemos;
        
        // ÈÄöÁî®ÂºπÁ™óÂõûË∞É
        let iosDialogOnConfirm = null;
        let iosDialogOnCancel = null;

        let selectionMode = false;
        let selectedMemoIds = new Set();
        let longPressTimer;
        let activeMemoId = null; 
        let isExpanded = false;
        let currentEditingId = null; 
        let initialTitle = '';
        let initialContent = '';
        
        // ÂæÆ‰ø°ËÅäÂ§©Êï∞ÊçÆ
        let currentChatUser = '';
        let currentChatAvatar = '';
        let currentChatColor = '';
        let shadowRoot = null; // Áî®‰∫éÊ†∑ÂºèÈ¢ÑËßà
        
        // ‰∏¥Êó∂Â≠òÂÇ®ËÆæÁΩÆ‰∏≠ÁöÑÂõæÁâáÊï∞ÊçÆÔºå‰øùÂ≠òÊó∂ÊâçÂ∫îÁî®
        let tempAvatarData = null;
        let tempBgData = null;
        let tempMyAvatarData = null;

        // Â≠òÂÇ®Â•ΩÂèãËØ¶ÁªÜËÆæÁΩÆ
        let chatSettingsMap = JSON.parse(localStorage.getItem('ios_chat_settings')) || {};
        
        // API ËÆæÁΩÆ
        let apiSettings = JSON.parse(localStorage.getItem('ios_api_settings')) || {
            endpoint: '',
            key: '',
            model: ''
        };
        
        // ËÅäÂ§©ËÆ°Êï∞Âô®ÔºàÁî®‰∫éËß¶ÂèëËÆ∞ÂøÜÔºâ
        let chatMessageCounts = {};

        // ËÅäÂ§©ÂàóË°®Êï∞ÊçÆ
        const defaultChats = [
            { name: 'Êñá‰ª∂‰º†ËæìÂä©Êâã', avatarClass: 'green', avatarText: 'üìÅ', bg: '#07C160', time: '19:20', msg: '[ÂõæÁâá]' },
            { name: 'Â¶àÂ¶à', avatarClass: 'orange', avatarText: 'üë©', bg: '#fa9d3b', time: '18:30', msg: '‰ªäÊôöÂõûÂÆ∂ÂêÉÈ•≠ÂêóÔºüÂÅö‰∫Ü‰Ω†Áà±ÂêÉÁöÑ„ÄÇ' },
            { name: '‰∫ßÂìÅÁªèÁêÜ', avatarClass: 'blue', avatarText: 'üëî', bg: '#10aeff', time: '14:05', msg: 'Ëøô‰∏™ÈúÄÊ±ÇËøòÂæóÊîπ‰∏Ä‰∏ãÔºåÂÆ¢Êà∑ËØ¥Ë¶Å‰∫îÂΩ©ÊñëÊñìÁöÑÈªë„ÄÇ' },
            { name: 'ËÆ¢ÈòÖÂè∑Ê∂àÊÅØ', avatarClass: '', avatarText: 'üì∞', bg: '#576b95', time: '10:00', msg: 'Â∞èÈúÅÁöÑÂ∞èÊâãÊú∫Êõ¥Êñ∞Âï¶ÔºÅÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ„ÄÇ' },
            { name: 'Ê∏∏Êàè‰∏≠ÂøÉ', avatarClass: '', avatarText: 'üéÆ', bg: '#dbdbdb', time: 'Êò®Â§©', msg: 'Â•ΩÂèãÂº†‰∏âÈÄÅ‰∫Ü‰Ω†‰∏ÄÈ¢óÁà±ÂøÉ„ÄÇ' }
        ];
        let chatListState = JSON.parse(localStorage.getItem('ios_chat_list')) || defaultChats;

        function saveMemosToStorage() {
            localStorage.setItem('ios_memos', JSON.stringify(memos));
        }
        function saveChatSettingsToStorage() {
            localStorage.setItem('ios_chat_settings', JSON.stringify(chatSettingsMap));
        }
        function saveChatListToStorage() {
            localStorage.setItem('ios_chat_list', JSON.stringify(chatListState));
        }

        // ÂàùÂßãÂåñ
        renderMemos();
        renderChatList();

        // ÂÖ®Â±ÄÔºöËøîÂõûÊ°åÈù¢
        function showDesktop() {
            // ÂÖ≥Èó≠ÊâÄÊúâ App
            document.querySelectorAll('.app-container').forEach(el => el.classList.remove('active'));
            document.getElementById('phoneScreen').classList.remove('app-active');
            
            // Ê∏ÖÁêÜÁä∂ÊÄÅ
            exitSelectionMode(); 
            hideSettingsMenu();
            if (document.getElementById('memo-create-modal').classList.contains('active')) {
                 closeCreateModal();
            }
            // ÈáçÁΩÆÂæÆ‰ø°Áä∂ÊÄÅ
            closeChatDetail();
            // ‰πãÂâçÊúâÂÖ≥Èó≠Áæ§ËÅäÂàóË°®È°µÁöÑÈÄªËæëÔºåÁé∞Â∑≤Â∫üÂºÉ
            document.getElementById('wechat-plus-menu').classList.remove('active');
            closeWeChatInputModal();
            closeChatSettings();
        }

        // ËÆæÁΩÆ App ÈÄªËæë
        function openSettingsApp() {
            document.getElementById('settings-app').classList.add('active');
            document.getElementById('phoneScreen').classList.add('app-active');
            
            // Âä†ËΩΩËÆæÁΩÆÂà∞ËæìÂÖ•Ê°Ü
            document.getElementById('apiEndpoint').value = apiSettings.endpoint || '';
            document.getElementById('apiKey').value = apiSettings.key || '';
            document.getElementById('apiModel').value = apiSettings.model || '';
        }

        function saveApiSettings() {
            const endpoint = document.getElementById('apiEndpoint').value.trim();
            const key = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('apiModel').value.trim();
            
            apiSettings = { endpoint, key, model };
            localStorage.setItem('ios_api_settings', JSON.stringify(apiSettings));
            
            showToast('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
            
            // ÂèØÈÄâÔºöÊ∑ªÂä†ÈúáÂä®ÂèçÈ¶àÊàñÊ®°ÊãüÁΩëÁªúÊµãËØï
        }

        // ----------------- Ê®°ÂûãÂàóË°®Ëé∑ÂèñÈÄªËæë -----------------
        async function fetchModelList() {
            const endpoint = document.getElementById('apiEndpoint').value.trim();
            const key = document.getElementById('apiKey').value.trim();

            if (!endpoint) {
                showToast('ËØ∑ÂÖàËæìÂÖ•Êé•Âè£Âú∞ÂùÄ');
                return;
            }

            // ÁÆÄÂçïÁöÑÂä†ËΩΩÊèêÁ§∫
            showToast('Ê≠£Âú®Ëé∑ÂèñÊ®°Âûã...');
            
            try {
                // ÊûÑÈÄ† URLÔºåÈÄöÂ∏∏ÊòØ /v1/models
                // Â¶ÇÊûúÁî®Êà∑ËæìÂÖ•ÁöÑÊòØ https://api.openai.com/v1ÔºåÂàôÂéªÊéâ /v1 ÂêéÁöÑÊñúÊù†ÂÜçÊãºÊé•
                let baseUrl = endpoint;
                if (baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);
                // ËÆ∏Â§öÂÖºÂÆπÊé•Âè£ÊòØ /v1/modelsÔºå‰ΩÜ‰πüÊúâ‰∫õÊòØÁõ¥Êé• /modelsÔºåËøôÈáåÂÅáËÆæÊ†áÂáÜ OpenAI Ê†ºÂºè
                const url = `${baseUrl}/models`;

                const headers = {};
                if (key) {
                    headers['Authorization'] = `Bearer ${key}`;
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Ëß£ÊûêÊï∞ÊçÆ
                let models = [];
                if (Array.isArray(data.data)) {
                    models = data.data; // Ê†áÂáÜ OpenAI Ê†ºÂºè
                } else if (Array.isArray(data)) {
                    models = data; // Êüê‰∫õÈùûÊ†áÂáÜÊé•Âè£
                } else {
                    console.error('Êó†Ê≥ïËß£ÊûêÊ®°ÂûãÊï∞ÊçÆ:', data);
                    showToast('Êï∞ÊçÆÊ†ºÂºèÊó†Ê≥ïËØÜÂà´');
                    return;
                }

                // ÊéíÂ∫èÔºöÁÆÄÂçïÁöÑÊåâÂ≠óÊØçÊéíÂ∫è
                models.sort((a, b) => (a.id || '').localeCompare(b.id || ''));

                renderModelList(models);
                document.getElementById('model-select-modal').classList.add('active');

            } catch (error) {
                console.error('Ëé∑ÂèñÊ®°ÂûãÂ§±Ë¥•:', error);
                showToast('Ëé∑ÂèñÂ§±Ë¥•: ' + error.message);
            }
        }

        function renderModelList(models) {
            const container = document.getElementById('model-list-container');
            container.innerHTML = '';

            if (models.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Êú™ÊâæÂà∞Ê®°Âûã</div>';
                return;
            }

            models.forEach(model => {
                const div = document.createElement('div');
                div.style.padding = '12px 15px';
                div.style.borderBottom = '1px solid rgba(0,0,0,0.05)';
                div.style.cursor = 'pointer';
                div.style.fontSize = '15px';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                
                // ÈÄâ‰∏≠È´ò‰∫Æ
                const currentModel = document.getElementById('apiModel').value.trim();
                const isSelected = model.id === currentModel;
                if (isSelected) {
                    div.style.color = '#007aff';
                    div.style.fontWeight = '600';
                } else {
                    div.style.color = '#333';
                }

                div.onclick = () => selectModel(model.id);

                div.innerHTML = `
                    <span>${model.id}</span>
                    ${isSelected ? '<span style="color:#007aff;">‚úì</span>' : ''}
                `;
                container.appendChild(div);
            });
        }

        function selectModel(modelId) {
            document.getElementById('apiModel').value = modelId;
            closeModelModal();
            // ËøôÈáå‰∏çËá™Âä®‰øùÂ≠òÔºåËÆ©Áî®Êà∑ÊâãÂä®ÁÇπ‰øùÂ≠òÔºåÊàñËÄÖ‰Ω†ÂèØ‰ª•ÈÄâÊã©Ëá™Âä®‰øùÂ≠ò
            // showToast('Â∑≤ÈÄâÊã© ' + modelId);
        }

        function closeModelModal() {
            document.getElementById('model-select-modal').classList.remove('active');
        }

        // Â§áÂøòÂΩï App ÈÄªËæë
        function openMemoApp() {
            document.getElementById('memo-app').classList.add('active');
            document.getElementById('phoneScreen').classList.add('app-active');
            exitSelectionMode(); 
            hideSettingsMenu();
        }

        // ÂæÆ‰ø° App ÈÄªËæë
        function openWeChatApp() {
            document.getElementById('wechat-app').classList.add('active');
            document.getElementById('phoneScreen').classList.add('app-active');
        }

        function switchWeChatTab(index) {
            // ÂàáÊç¢ Tab Ê†∑Âºè
            const tabs = document.querySelectorAll('.wechat-tab');
            tabs.forEach((tab, i) => {
                if (i === index) tab.classList.add('active');
                else tab.classList.remove('active');
            });
            
            // ÂàáÊç¢È°µÈù¢
            const pages = document.querySelectorAll('.wechat-page');
            pages.forEach((page, i) => {
                if (i === index) page.classList.add('active');
                else page.classList.remove('active');
            });
        }
        
        function openChatDetail(name, colorClass, emoji) {
            currentChatUser = name;
            currentChatColor = colorClass; 
            currentChatAvatar = emoji; 
            
            // ÂàùÂßãÂåñÊï∞ÊçÆ
            if (!chatSettingsMap[name]) {
                chatSettingsMap[name] = {
                    remark: '',
                    friendPersona: '',
                    myPersona: ''
                };
            }

            // ÂàùÂßãÂåñËØ•‰ºöËØùÁöÑ‰∏¥Êó∂ËÆ°Êï∞Âô®ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
            if (typeof chatMessageCounts[name] === 'undefined') {
                chatMessageCounts[name] = 0;
            }
            
            // ÊòæÁ§∫ÂêçÂ≠óÔºà‰ºòÂÖàÊòæÁ§∫Â§áÊ≥®Ôºâ
            const data = chatSettingsMap[name];
            document.getElementById('chatTitle').innerText = data.remark || name;
            
            // Â∫îÁî®ËÅäÂ§©ËÉåÊôØ
            const detailPage = document.getElementById('wechat-chat-detail');
            if (data.chatBg) {
                detailPage.style.backgroundImage = `url(${data.chatBg})`;
                detailPage.style.backgroundSize = 'cover';
                detailPage.style.backgroundPosition = 'center';
            } else {
                detailPage.style.backgroundImage = 'none';
                detailPage.style.backgroundColor = '#ededed';
            }

            const chatBody = document.getElementById('chatBody');
            chatBody.innerHTML = ''; // Ê∏ÖÁ©∫

            // Ê∏≤ÊüìËÆ∞ÂøÜÊù°
            updateMemoryBar();
            
            // ‰ªÖÂØπÈ¢ÑËÆæÂ•ΩÂèãÊ®°ÊãüÊ∂àÊÅØÔºåÂØπÊñ∞Ê∑ªÂä†ÁöÑÂ•ΩÂèã‰øùÊåÅÁ©∫ÁôΩ
            const presetFriends = ['Êñá‰ª∂‰º†ËæìÂä©Êâã', 'Â¶àÂ¶à', '‰∫ßÂìÅÁªèÁêÜ'];
            if (presetFriends.includes(name)) {
                addChatMessage(name, '‰Ω†Â•ΩÔºÅ', false);
                addChatMessage(name, 'ÊúÄËøëÊÄé‰πàÊ†∑Ôºü', false);
            }
            
            // Â∫îÁî®Ëá™ÂÆö‰πâ CSS
            const dynamicStyle = document.getElementById('dynamic-chat-style');
            if (data.customCss) {
                dynamicStyle.innerHTML = data.customCss;
            } else {
                dynamicStyle.innerHTML = '';
            }
            
            document.getElementById('wechat-chat-detail').classList.add('active');
        }
        
        function closeChatDetail() {
            document.getElementById('wechat-chat-detail').classList.remove('active');
            document.getElementById('memory-list-panel').classList.remove('active');
            // Ê∏ÖÁêÜËá™ÂÆö‰πâÊ†∑Âºè
            document.getElementById('dynamic-chat-style').innerHTML = '';
        }
        
        function updateMemoryBar() {
            const settings = chatSettingsMap[currentChatUser] || {};
            const memories = settings.memoryList || [];
            const bar = document.getElementById('memory-bar');
            
            if (memories.length > 0) {
                bar.style.display = 'flex';
                bar.querySelector('span').innerText = `‚ú® Â≠òÂú® ${memories.length} Êù°ËÆ∞ÂøÜÊëòË¶ÅÔºåÁÇπÂáªÊü•Áúã`;
            } else {
                bar.style.display = 'none';
            }
        }
        
        function toggleMemoryPanel() {
            const panel = document.getElementById('memory-list-panel');
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
            } else {
                renderMemoryList();
                panel.classList.add('active');
            }
        }
        
        function renderMemoryList() {
            const settings = chatSettingsMap[currentChatUser] || {};
            const memories = settings.memoryList || [];
            const panel = document.getElementById('memory-list-panel');
            panel.innerHTML = '';

            // Ê∑ªÂä†ÊâãÂä®Ê∑ªÂä†ÊåâÈíÆ
            const addBtn = document.createElement('div');
            addBtn.className = 'memory-add-btn';
            addBtn.innerText = '+ ÊâãÂä®Ê∑ªÂä†ËÆ∞ÂøÜ';
            addBtn.onclick = addManualMemory;
            panel.appendChild(addBtn);
            
            if (memories.length === 0) {
                const emptyTip = document.createElement('div');
                emptyTip.style.textAlign = 'center';
                emptyTip.style.color = '#999';
                emptyTip.style.padding = '10px';
                emptyTip.innerText = 'ÊöÇÊó†ËÆ∞ÂøÜ';
                panel.appendChild(emptyTip);
                return;
            }
            
            // ÂÄíÂ∫èÊòæÁ§∫Ôºå‰∏∫‰∫ÜÊñπ‰æøÊìç‰ΩúÔºåÊàë‰ª¨ÁªôÊØè‰∏™ item ÁªëÂÆöÂéüÂßã index
            // ÂéüÊï∞ÁªÑÁ¥¢ÂºïÔºö0ÊòØÊóßÔºålength-1ÊòØÊñ∞
            // ÊòæÁ§∫Êó∂ÔºöÊñ∞Âú®È°∂
            // ÊâÄ‰ª•ÈÅçÂéÜÊó∂Ôºåindex ÊòØÂéüÊï∞ÁªÑÁöÑ index
            
            // ‰∏∫‰∫ÜÊ≠£Á°ÆÂ§ÑÁêÜ indexÔºåÊàë‰ª¨Áõ¥Êé•Êã∑Ë¥ù‰∏Ä‰ªΩÂ∏¶ index ÁöÑÊï∞ÊçÆÔºåÁÑ∂Âêé reverse
            const displayList = memories.map((m, i) => ({...m, originalIndex: i})).reverse();

            displayList.forEach(mem => {
                const div = document.createElement('div');
                div.className = 'memory-item';
                div.id = `memory-item-${mem.originalIndex}`;
                
                // Ê≠£Â∏∏ÊòæÁ§∫Ê®°Âºè
                const viewHTML = `
                    <div class="memory-header">
                        <div class="memory-time">${mem.time}</div>
                        <div class="memory-actions">
                            <span class="memory-action-btn" onclick="toggleEditMemory(${mem.originalIndex})" title="ÁºñËæë/Á≤æÁÆÄ">‚úèÔ∏è</span>
                            <span class="memory-action-btn" style="color:#ff3b30" onclick="deleteMemory(${mem.originalIndex})" title="Âà†Èô§">üóëÔ∏è</span>
                        </div>
                    </div>
                    <div class="memory-text">${mem.content}</div>
                `;
                
                // ÁºñËæëÊ®°Âºè HTML (ÈöêËóèÔºåÈÄöËøá JS ÂàáÊç¢)
                const editHTML = `
                    <div class="memory-header" style="margin-bottom:5px;">
                        <div class="memory-time">ÁºñËæëËÆ∞ÂøÜ</div>
                    </div>
                    <textarea class="memory-textarea" id="memory-edit-${mem.originalIndex}">${mem.content}</textarea>
                    <div class="memory-edit-footer">
                        <div class="memory-btn-sm" onclick="toggleEditMemory(${mem.originalIndex})">ÂèñÊ∂à</div>
                        <div class="memory-btn-sm memory-btn-save" onclick="saveMemoryEdit(${mem.originalIndex})">‰øùÂ≠ò</div>
                    </div>
                `;

                div.innerHTML = viewHTML;
                div.dataset.editMode = 'false';
                
                // ÊåÇËΩΩÂàáÊç¢ÈÄªËæë
                div.dataset.viewHtml = viewHTML;
                div.dataset.editHtml = editHTML;

                panel.appendChild(div);
            });
        }

        function toggleEditMemory(index) {
            const div = document.getElementById(`memory-item-${index}`);
            if (!div) return;
            
            const isEdit = div.dataset.editMode === 'true';
            
            if (isEdit) {
                // ÂàáÊç¢ÂõûÊü•Áúã
                div.innerHTML = div.dataset.viewHtml;
                div.dataset.editMode = 'false';
            } else {
                // ÂàáÊç¢Âà∞ÁºñËæë
                div.innerHTML = div.dataset.editHtml;
                div.dataset.editMode = 'true';
            }
        }

        function saveMemoryEdit(index) {
            const textarea = document.getElementById(`memory-edit-${index}`);
            if (!textarea) return;
            
            const newContent = textarea.value.trim();
            if (!newContent) {
                showToast('ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫');
                return;
            }
            
            const settings = chatSettingsMap[currentChatUser];
            if (settings && settings.memoryList && settings.memoryList[index]) {
                settings.memoryList[index].content = newContent;
                saveChatSettingsToStorage();
                showToast('ËÆ∞ÂøÜÂ∑≤Êõ¥Êñ∞');
                renderMemoryList(); // ÈáçÊñ∞Ê∏≤Êüì
            }
        }

        function deleteMemory(index) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§ËøôÊù°ËÆ∞ÂøÜÂêóÔºü')) return;
            
            const settings = chatSettingsMap[currentChatUser];
            if (settings && settings.memoryList) {
                settings.memoryList.splice(index, 1);
                saveChatSettingsToStorage();
                showToast('ËÆ∞ÂøÜÂ∑≤Âà†Èô§');
                renderMemoryList();
                updateMemoryBar();
            }
        }

        function addManualMemory() {
            const content = prompt("ËØ∑ËæìÂÖ•ËÆ∞ÂøÜÂÜÖÂÆπÔºö");
            if (content && content.trim()) {
                const settings = chatSettingsMap[currentChatUser];
                if (!settings.memoryList) settings.memoryList = [];
                // Ê∑ªÂä†Âà∞ÂàóË°®
                settings.memoryList.push({
                    time: new Date().toLocaleString(),
                    content: content.trim()
                });
                saveChatSettingsToStorage();
                renderMemoryList();
                updateMemoryBar();
                showToast("Â∑≤Ê∑ªÂä†ËÆ∞ÂøÜ");
            }
        }

        // ÈìæÊé•Ê®°ÂùóÁõ∏ÂÖ≥
        function showLinkInputModal() {
            hideWeChatMenu();
            document.getElementById('link-input-modal').classList.add('active');
            // Ê∏ÖÁ©∫
            document.getElementById('linkUrl').value = '';
            document.getElementById('linkTitle').value = '';
            document.getElementById('linkDesc').value = '';
            document.getElementById('linkImg').value = '';
            document.getElementById('linkLoading').style.display = 'none';
        }

        function closeLinkInputModal() {
            document.getElementById('link-input-modal').classList.remove('active');
        }

        function simulateLinkPreview() {
            const url = document.getElementById('linkUrl').value;
            const titleInput = document.getElementById('linkTitle');
            const descInput = document.getElementById('linkDesc');
            
            // Â¶ÇÊûúÂ∑≤ÊúâÂÜÖÂÆπÔºå‰∏çË¶ÜÁõñ
            if (titleInput.value || !url) return;

            document.getElementById('linkLoading').style.display = 'block';
            
            // Ê®°ÊãüÂª∂ËøüËØªÂèñ
            setTimeout(() => {
                document.getElementById('linkLoading').style.display = 'none';
                
                // ÁÆÄÂçïÁöÑÊ®°ÊãüÁîüÊàê
                let domain = 'Êú™Áü•ÁΩëÁ´ô';
                try {
                    domain = new URL(url).hostname;
                } catch(e) {}
                
                titleInput.value = `Êù•Ëá™ ${domain} ÁöÑÁ≤æÂΩ©ÂÜÖÂÆπ`;
                descInput.value = `ÁÇπÂáªÊü•ÁúãÂÖ≥‰∫é ${url} ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇËøôÊòØ‰∏Ä‰∏™Ê®°ÊãüÁöÑÈìæÊé•ËØªÂèñÈ¢ÑËßàÊïàÊûú„ÄÇ`;
                // ÈöèÊú∫Êîæ‰∏Ä‰∏™ placeholder ÂõæÁâá
                document.getElementById('linkImg').value = 'https://api.iconify.design/mdi:web.svg?color=%23888888';
                
            }, 800);
        }

        function sendLinkMessage() {
            const url = document.getElementById('linkUrl').value;
            const title = document.getElementById('linkTitle').value;
            const desc = document.getElementById('linkDesc').value;
            const img = document.getElementById('linkImg').value;
            
            if (!url) {
                showToast('ËØ∑ËæìÂÖ•ÈìæÊé•');
                return;
            }
            if (!title) {
                showToast('ËØ∑ËæìÂÖ•Ê†áÈ¢ò');
                return;
            }

            const msgData = {
                type: 'link',
                url: url,
                title: title,
                desc: desc,
                img: img
            };
            
            // ÂèëÈÄÅÊ∂àÊÅØ
            addChatMessage('Êàë', msgData, true); // ÊàëÂèëÈÄÅ
            
            closeLinkInputModal();
        }

        function openLinkPreview(data) {
            const modal = document.getElementById('link-preview-modal');
            const titleEl = document.getElementById('lpHeaderTitle');
            const contentEl = document.getElementById('lpContent');
            
            titleEl.innerText = data.title || 'ÁΩëÈ°µÊµèËßà';
            
            // Ê®°ÊãüÁΩëÈ°µÂÜÖÂÆπ
            const imgHtml = data.img ? `<img src="${data.img}" class="lp-img">` : '';
            const dateStr = new Date().toLocaleDateString();
            
            contentEl.innerHTML = `
                <div class="lp-article-title">${data.title}</div>
                <div class="lp-meta">Â∞èÈúÅÁöÑÂ∞èÊâãÊú∫ ¬∑ ${dateStr}</div>
                ${imgHtml}
                <div class="lp-text">
                    <p>${data.desc || 'ÊöÇÊó†ÊëòË¶Å'}</p>
                    <br>
                    <p>ËøôÊòØ‰∏Ä‰∏™Ê®°ÊãüÁöÑÈìæÊé•È¢ÑËßàÈ°µÈù¢„ÄÇÂú®ÁúüÂÆûÂ∫îÁî®‰∏≠ÔºåËøôÈáå‰ºöÈÄöËøá iframe Âä†ËΩΩ ${data.url}ÔºåÊàñËÄÖÈÄöËøáÂêéÁ´Ø API ÊäìÂèñÁΩëÈ°µÊ≠£ÊñáÂÜÖÂÆπÂπ∂Ê∏≤Êüì„ÄÇ</p>
                    <p>ÂΩìÂâçÈ°µÈù¢‰ªÖ‰ªÖÂ±ïÁ§∫‰∫Ü‰ªéÂç°Áâá‰º†ÈÄíËøáÊù•ÁöÑÂÖÉÊï∞ÊçÆ‰ø°ÊÅØ„ÄÇ</p>
                    <br>
                    <div style="padding:15px;background:#f5f5f5;border-radius:8px;font-size:12px;color:#888;word-break:break-all;">
                        ÂéüÂßãÈìæÊé•Ôºö${data.url}
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function closeLinkPreview() {
            document.getElementById('link-preview-modal').classList.remove('active');
        }

        function checkAndGenerateMemory() {
            const name = currentChatUser;
            const settings = chatSettingsMap[name] || {};
            const threshold = parseInt(settings.memoryThreshold) || 20; // ÈªòËÆ§20Êù°
            
            if (!chatMessageCounts[name]) chatMessageCounts[name] = 0;
            chatMessageCounts[name]++;
            
            if (chatMessageCounts[name] >= threshold) {
                // Ëß¶ÂèëÊÄªÁªì
                chatMessageCounts[name] = 0; // ÈáçÁΩÆËÆ°Êï∞
                
                // Ê®°ÊãüÁîüÊàêÊëòË¶Å
                const time = new Date().toLocaleString();
                const summaryContent = `[Ëá™Âä®ÊÄªÁªì] Âú®ÊúÄËøëÁöÑ ${threshold} Êù°ÂØπËØù‰∏≠ÔºåÂèåÊñπ‰∫§ÊµÅÊÑâÂø´„ÄÇÁî®Êà∑Ë°®Áé∞Âá∫‰∫ÜÂØπÁªÜËäÇÁöÑÂÖ≥Ê≥®Ôºå${name} Áªô‰∫à‰∫ÜÁßØÊûÅÁöÑÂõûÂ∫î„ÄÇ`;
                
                if (!settings.memoryList) settings.memoryList = [];
                settings.memoryList.push({
                    time: time,
                    content: summaryContent
                });
                
                saveChatSettingsToStorage();
                updateMemoryBar();
                
                // Â¶ÇÊûúÈù¢ÊùøÊâìÂºÄÔºåÂÆûÊó∂Êõ¥Êñ∞
                if (document.getElementById('memory-list-panel').classList.contains('active')) {
                    renderMemoryList();
                }

                // Â¶ÇÊûúËÆæÁΩÆÈ°µÊâìÂºÄÔºå‰πüÂÆûÊó∂Êõ¥Êñ∞
                if (document.getElementById('wechat-settings-modal').classList.contains('active')) {
                    renderSettingsMemoryList();
                }
                
                showToast('‚ú® Â∑≤ÁîüÊàêÊñ∞ÁöÑËÆ∞ÂøÜÊëòË¶Å');
            }
        }
        
        function addChatMessage(name, text, isSelf, senderInfo = null) {
            const row = document.createElement('div');
            row.className = `chat-msg-row ${isSelf ? 'self' : ''}`;
            
            // Â§¥ÂÉè
            const avatarDiv = document.createElement('div');
            avatarDiv.className = `chat-avatar`;
            
            const settings = chatSettingsMap[currentChatUser] || {};
            
            if (isSelf) {
                // Ëá™Â∑±ÁöÑÂ§¥ÂÉè
                if (settings.myAvatarData) {
                    avatarDiv.style.background = 'transparent';
                    avatarDiv.innerHTML = `<img src="${settings.myAvatarData}" style="width:100%;height:100%;object-fit:cover;">`;
                } else {
                    avatarDiv.style.background = '#eee';
                    avatarDiv.innerHTML = 'ME'; 
                    avatarDiv.style.color = '#333';
                    avatarDiv.style.fontWeight = 'bold';
                    avatarDiv.style.fontSize = '12px';
                }
            } else {
                // ÂØπÊñπ (ÂçïËÅäÂ•ΩÂèã Êàñ Áæ§ËÅäÊàêÂëò)
                let targetName = currentChatUser;
                let targetSettings = settings;
                
                if (senderInfo) {
                    // Áæ§ËÅä‰∏≠ÁöÑÂÖ∑‰ΩìÂèëÈÄÅËÄÖ
                    targetName = senderInfo.name;
                    targetSettings = chatSettingsMap[targetName] || {};
                    
                    // Â∞ùËØïÊü•ÊâæÈ¢úËâ≤
                    const memberInList = chatListState.find(c => c.name === targetName);
                    if (memberInList && memberInList.avatarClass) {
                        avatarDiv.classList.add(memberInList.avatarClass);
                    } else {
                        avatarDiv.style.background = '#ddd'; 
                    }
                } else {
                    // ÂçïËÅä
                    if (currentChatColor) avatarDiv.classList.add(currentChatColor);
                }

                if (targetSettings.avatarData) {
                    avatarDiv.style.background = 'transparent';
                    avatarDiv.innerHTML = `<img src="${targetSettings.avatarData}" style="width:100%;height:100%;object-fit:cover;">`;
                } else {
                    if (senderInfo) {
                        // Áæ§ËÅäÊàêÂëòÈªòËÆ§ÊñáÂ≠óÂ§¥ÂÉè
                        avatarDiv.innerText = targetName[0];
                        avatarDiv.style.fontSize = '14px';
                        avatarDiv.style.color = '#fff';
                        avatarDiv.style.display = 'flex';
                        avatarDiv.style.justifyContent = 'center';
                        avatarDiv.style.alignItems = 'center';
                    } else {
                        // ÂçïËÅäÈªòËÆ§ Emoji
                        avatarDiv.innerHTML = currentChatAvatar;
                        avatarDiv.style.fontSize = '24px';
                    }
                }
            }
            
            // Ê∂àÊÅØÂÜÖÂÆπÂåÖË£πÂ±Ç
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-msg-content';

            // ÊòæÁ§∫ÂêçÂ≠ó (Áæ§ËÅä‰∏îÈùûËá™Â∑±)
            if (!isSelf && senderInfo) {
                const nameDiv = document.createElement('div');
                nameDiv.className = 'chat-msg-name';
                nameDiv.innerText = senderInfo.name;
                nameDiv.style.display = 'block';
                contentDiv.appendChild(nameDiv);
            }
            
            // Ê∞îÊ≥°ÂÜÖÂÆπÂ§ÑÁêÜ
            if (typeof text === 'object' && text.type === 'link') {
                // Ê∏≤ÊüìÈìæÊé•Âç°Áâá
                const card = document.createElement('div');
                card.className = 'chat-link-card';
                card.onclick = () => openLinkPreview(text);
                
                const thumbHtml = text.img ? `<img src="${text.img}" class="link-card-thumb">` : `<div class="link-card-thumb" style="display:flex;justify-content:center;align-items:center;color:#999;font-size:24px;">üîó</div>`;
                
                card.innerHTML = `
                    <div class="link-card-title">${text.title}</div>
                    <div class="link-card-content">
                        <div class="link-card-desc">${text.desc || text.url}</div>
                        ${thumbHtml}
                    </div>
                    <div class="link-card-footer">
                        <svg style="width:12px;height:12px;fill:#aaa;" viewBox="0 0 24 24"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M11,17h2v-6h-2V17z M12,9c0.55,0,1-0.45,1-1c0-0.55-0.45-1-1-1s-1,0.45-1,1C11,8.55,11.45,9,12,9z"/></svg>
                        ÁΩëÈ°µÈìæÊé•
                    </div>
                `;
                
                // Âç°Áâá‰∏çÈúÄË¶ÅÂ§ñÂ±ÇÊ∞îÊ≥°ËÉåÊôØÔºåÁõ¥Êé•‰Ωú‰∏∫ content
                contentDiv.appendChild(card);
                
            } else {
                // ÊôÆÈÄöÊñáÊú¨Ê∞îÊ≥°
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';
                bubble.innerText = text;
                contentDiv.appendChild(bubble);
            }
            
            row.appendChild(avatarDiv);
            row.appendChild(contentDiv);
            
            document.getElementById('chatBody').appendChild(row);
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            const chatBody = document.getElementById('chatBody');
            chatBody.scrollTop = chatBody.scrollHeight;
            
            // Ê£ÄÊü•ËÆ∞ÂøÜËß¶Âèë
            checkAndGenerateMemory();
        }

        // ËæÖÂä©ÂáΩÊï∞ÔºöÊ†πÊçÆ‰∫∫ËÆæÁîüÊàêÂõûÂ§ç
        function getReplyFromPersona(persona, name) {
            persona = (persona || '').toLowerCase();
            name = (name || '').toLowerCase();
            
            let replies = ['Êî∂Âà∞ÔºÅ', 'ÂìàÂìàÂìàÂìà', 'Á°ÆÂÆû', 'Â•ΩÁöÑÔºåÊ≤°ÈóÆÈ¢ò', 'Á®çÁ≠â‰∏Ä‰∏ã'];

            if (persona.includes('Â¶àÂ¶à') || persona.includes('ÊØç‰∫≤') || name.includes('Â¶à')) {
                replies = ['Â§öÁ©øÁÇπË°£Êúç', '‰ªÄ‰πàÊó∂ÂÄôÂõûÂÆ∂ÂêÉÈ•≠Ôºü', 'Âà´Â§™Á¥Ø‰∫Ü', 'ËÆ∞ÂæóÂñùÊ∞¥', 'ÂÆ∂ÈáåÈÉΩÂ•Ω', 'Êó©ÁÇπ‰ºëÊÅØ', 'Èí±Â§ü‰∏çÂ§üËä±Ôºü', 'Â§©Ê∞îÂÜ∑‰∫ÜÊ≥®ÊÑè‰øùÊöñ'];
            } else if (persona.includes('ËÄÅÊùø') || persona.includes('ÁªèÁêÜ') || persona.includes('Â∑•‰Ωú')) {
                replies = ['Ëøô‰∏™ÊñπÊ°àÂÜçÊîπÊîπ', 'Êî∂Âà∞', 'ÊòéÂ§©ÂºÄ‰ºöÁªÜËØ¥', 'ËæõËã¶‰∫Ü', 'Ëøô‰∏™ÈúÄÊ±ÇÂæàÊÄ•', 'ËøòÊ≤°ÂÅöÂÆåÂêóÔºü', 'Áª©ÊïàËÄÉÊ†∏Ë¶ÅÊ≥®ÊÑè', 'Êù•ÊàëÂäûÂÖ¨ÂÆ§‰∏ÄË∂ü'];
            } else if (persona.includes('È´òÂÜ∑')) {
                replies = ['ÂóØ', 'Âì¶', 'Â∑≤ËØª', '...', 'Ë°å', 'Ôºü', 'Ê≤°Á©∫', 'ÂÜçËØ¥'];
            } else if (persona.includes('ÁÉ≠ÊÉÖ') || persona.includes('ÂèØÁà±') || persona.includes('ËàîÁãó')) {
                replies = ['ÂìáÂ°ûÂ§™Ê£í‰∫ÜÔºÅüòç', '‰Ω†ËØ¥ÁöÑÈÉΩÂØπÔºÅ', 'Â§©Âì™ÁúüÁöÑÂêóÔºü', 'ÈöèÊó∂ÂæÖÂëΩÔºÅ', 'Â•ΩÂëÄÂ•ΩÂëÄÔºÅ', 'Ë¥¥Ë¥¥~', 'ÊÉ≥‰Ω†Âï¶ÔºÅ', '‰ªäÂ§©‰πüÊòØÂÖÉÊ∞îÊª°Êª°ÁöÑ‰∏ÄÂ§©ÔºÅ'];
            } else if (persona.includes('Êö¥Ë∫Å') || persona.includes('ÁîüÊ∞î')) {
                replies = ['Âà´ÁÉ¶Êàë', 'Êªö', '‰Ω†ÂÜçËØ¥‰∏ÄÈÅçÔºü', 'Êó†ËØ≠', 'Â§ßÂßê‰Ω†Ê≤°‰∫ãÂêß', 'ËøôÊòØ‰∫∫Âπ≤ÁöÑ‰∫ãÔºü', 'Ê∞îÊ≠ªÊàë‰∫Ü', '‰∏ÄËæπÁé©Âéª'];
            } else if (persona.includes('Áæ§ËÅäÊàêÂëò') || persona.includes('member')) {
                replies = ['ÂìàÂìà', 'ËøôÂ∞±Âéª', 'Â∏¶Êàë‰∏Ä‰∏™', '666', 'Á¨ëÊ≠ª', 'ÁúüÁöÑÂÅáÁöÑ', 'Âä†‰∏Ä', 'Âêå‰∏ä', 'Â§™Âº∫‰∫Ü'];
            }
            
            return replies[Math.floor(Math.random() * replies.length)];
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            
            // ÂèëÈÄÅËá™Â∑±ÁöÑÊ∂àÊÅØ
            addChatMessage('Êàë', text, true);
            input.value = '';
            
            // ÂèñÊ∂àËá™Âä®ÂõûÂ§çÔºåÊîπ‰∏∫ÊâãÂä®Ëß¶Âèë
        }

        // ÊâãÂä®Ëß¶Âèë AI ÂõûÂ§ç
        function triggerAIResponse(isRegenerate) {
            if (isRegenerate) {
                // ÈáçÊñ∞ÁîüÊàêÔºöÂà†Èô§ÊúÄÂêé‰∏ÄÊù°ÂØπÊñπÁöÑÊ∂àÊÅØ
                const chatBody = document.getElementById('chatBody');
                const lastMsg = chatBody.lastElementChild;
                if (lastMsg && !lastMsg.classList.contains('self')) {
                    lastMsg.remove();
                } else {
                    // Â¶ÇÊûúÊúÄÂêé‰∏ÄÊù°‰∏çÊòØÂØπÊñπÊ∂àÊÅØÔºåÊèêÁ§∫Êó†Ê≥ïÈáçÁîüÊàê
                    showToast('Ê≤°ÊúâÂèØÈáçÁîüÊàêÁöÑÂõûÂ§ç');
                    return;
                }
            }

            const settings = chatSettingsMap[currentChatUser] || {};
            const isGroup = !!settings.members;
            const delay = isRegenerate ? 300 : 1000;

            if (isGroup) {
                // Áæ§ËÅäÈÄªËæëÔºöÂÖ®ÂëòÊé•ÈæôÂõûÂ§ç
                const members = settings.members;
                if (!members || members.length === 0) {
                    // Â¶ÇÊûúÊï∞ÊçÆÂºÇÂ∏∏ÔºåÂõûËêΩÂà∞ÈªòËÆ§
                    setTimeout(() => {
                        addChatMessage(currentChatUser, 'ÔºàÁæ§ÈáåÊ≤°‰∫∫ËØ¥ËØùÔºâ', false);
                    }, delay);
                    return;
                }

                // ÈÅçÂéÜÊâÄÊúâÊàêÂëòÂõûÂ§ç
                members.forEach((member, index) => {
                    const speakerSettings = chatSettingsMap[member] || {};
                    const persona = (speakerSettings.friendPersona || '').toLowerCase();
                    const reply = getReplyFromPersona(persona, member);
                    
                    // Ê®°ÊãüÈôÜÈôÜÁª≠Áª≠ÂõûÂ§çÔºöÂü∫Á°ÄÂª∂Ëøü + È°∫Â∫èÈó¥Èöî + ÈöèÊú∫Ê≥¢Âä®
                    const sequenceDelay = index * 1500; // ÊØè‰∏™‰∫∫Èó¥ÈöîÁ∫¶1.5Áßí
                    const randomJitter = Math.random() * 1000; // ÈöèÊú∫Ê≥¢Âä®1ÁßíÂÜÖ
                    const finalDelay = delay + sequenceDelay + randomJitter;

                    setTimeout(() => {
                        addChatMessage(currentChatUser, reply, false, { name: member });
                    }, finalDelay);
                });

            } else {
                // ÂçïËÅäÈÄªËæë
                const persona = (settings.friendPersona || '').toLowerCase();
                const name = currentChatUser.toLowerCase();
                
                const reply = getReplyFromPersona(persona, name);

                setTimeout(() => {
                    addChatMessage(currentChatUser, reply, false);
                }, delay);
            }
        }


        // Ê∏≤ÊüìÂ§áÂøòÂΩïÂàóË°®
        function renderMemos() {
            const list = document.getElementById('memoList');
            list.innerHTML = '';
            
            // ÊéíÂ∫èÔºöÁΩÆÈ°∂ÁöÑÂú®Ââç
            memos.sort((a, b) => (b.pinned - a.pinned) || (b.id - a.id));

            memos.forEach(memo => {
                const div = document.createElement('div');
                div.className = `memo-item ${memo.pinned ? 'pinned' : ''} ${selectedMemoIds.has(memo.id) ? 'selected' : ''}`;
                
                // ÈïøÊåâÈÄªËæë
                div.onmousedown = (e) => startLongPress(e, memo.id);
                div.ontouchstart = (e) => startLongPress(e, memo.id);
                div.onmouseup = cancelLongPress;
                div.ontouchend = cancelLongPress;
                div.onmousemove = cancelLongPress; // ÁßªÂä®ÂèñÊ∂à

                // ÁÇπÂáªÈÄªËæë
                div.onclick = () => handleMemoClick(memo.id);

                div.innerHTML = `
                    <div class="memo-select-circle"></div>
                    <div class="memo-info">
                        <div class="memo-item-title">${memo.title || 'Êó†Ê†áÈ¢ò'}</div>
                        <div class="memo-item-preview">${memo.content || 'Êó†ÂÜÖÂÆπ'}</div>
                        <div class="memo-item-date">${memo.date}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // Êñ∞Âª∫/ÁºñËæëÂ§áÂøòÂΩï
        function openMemoModal(memoId = null) {
            document.getElementById('memo-create-modal').classList.add('active');
            
            if (memoId) {
                // ÁºñËæëÊ®°Âºè
                currentEditingId = memoId;
                const memo = memos.find(m => m.id === memoId);
                initialTitle = memo.title;
                initialContent = memo.content;
            } else {
                // Êñ∞Âª∫Ê®°Âºè
                currentEditingId = null;
                initialTitle = '';
                initialContent = '';
            }
            document.getElementById('newMemoTitle').value = initialTitle;
            document.getElementById('newMemoContent').value = initialContent;
        }

        function toggleExpandModal() {
            const modal = document.getElementById('memo-create-modal');
            isExpanded = !isExpanded;
            if (isExpanded) {
                modal.classList.add('expanded');
            } else {
                modal.classList.remove('expanded');
            }
        }

        function tryCloseCreateModal() {
            const currentTitle = document.getElementById('newMemoTitle').value;
            const currentContent = document.getElementById('newMemoContent').value;

            // Ê£ÄÊµãÊõ¥Êîπ
            if (currentTitle !== initialTitle || currentContent !== initialContent) {
                showIOSDialog(
                    'Â∏åÊúõ‰øùÂ≠òÊõ¥ÊîπÂêóÔºü',
                    'ÊÇ®ÁöÑ‰øÆÊîπÂ∞öÊú™‰øùÂ≠ò„ÄÇ',
                    () => { saveMemo(); },      // Á°ÆÂÆö -> ‰øùÂ≠ò
                    () => { closeCreateModal(); }, // ÂèñÊ∂à -> ‰∏ç‰øùÂ≠òÔºàÁõ¥Êé•ÂÖ≥Èó≠Ôºâ
                    '‰∏ç‰øùÂ≠ò',
                    '‰øùÂ≠ò'
                );
            } else {
                closeCreateModal();
            }
        }

        // ÈÄöÁî®ÂºπÁ™óÈÄªËæë
        function showIOSDialog(title, desc, onConfirm, onCancel = null, cancelText = 'ÂèñÊ∂à', confirmText = 'Á°ÆÂÆö') {
            document.getElementById('iosModalTitle').innerText = title;
            document.getElementById('iosModalDesc').innerText = desc;
            document.getElementById('iosModalCancelBtn').innerText = cancelText;
            document.getElementById('iosModalConfirmBtn').innerText = confirmText;
            
            // ËÆæÁΩÆÊ†∑ÂºèÔºöÂ¶ÇÊûúÊòØ‚ÄúÂà†Èô§‚ÄùÊìç‰ΩúÔºåÁ°ÆÂÆöÊåâÈíÆÈÄöÂ∏∏‰∏∫Á∫¢Ëâ≤ÔºõÂ¶ÇÊûúÊòØ‚Äú‰øùÂ≠ò‚ÄùÔºåÈÄöÂ∏∏Âä†Á≤ó„ÄÇ
            // ËøôÈáåÁÆÄÂçïÂ§ÑÁêÜÔºöÂ¶ÇÊûú confirmText ÊòØ 'Âà†Èô§'ÔºåÂä†‰∏™Á∫¢Ëâ≤Ê†∑ÂºèÁ±ªÔºàÂèØÈÄâÔºåÊöÇ‰∏çÂÆûÁé∞Â§çÊùÇÊ†∑ÂºèÂàáÊç¢Ôºå‰øùÊåÅ boldÔºâ
            const confirmBtn = document.getElementById('iosModalConfirmBtn');
            if (confirmText === 'Âà†Èô§') {
                confirmBtn.style.color = '#ff3b30';
            } else {
                confirmBtn.style.color = '#007aff';
            }

            iosDialogOnConfirm = onConfirm;
            iosDialogOnCancel = onCancel;
            
            document.getElementById('iosModal').classList.add('active');
        }

        function handleIOSDialog(isConfirm) {
            document.getElementById('iosModal').classList.remove('active');
            if (isConfirm) {
                if (iosDialogOnConfirm) iosDialogOnConfirm();
            } else {
                if (iosDialogOnCancel) iosDialogOnCancel();
            }
            // Reset
            iosDialogOnConfirm = null;
            iosDialogOnCancel = null;
        }

        function closeCreateModal() {
            const modal = document.getElementById('memo-create-modal');
            modal.classList.remove('active');
            modal.classList.remove('expanded');
            isExpanded = false;
            currentEditingId = null;
        }

        function saveMemo() {
            const title = document.getElementById('newMemoTitle').value;
            const content = document.getElementById('newMemoContent').value;
            
            if (!title && !content) {
                closeCreateModal();
                return;
            }

            if (currentEditingId) {
                // Êõ¥Êñ∞Áé∞Êúâ
                const idx = memos.findIndex(m => m.id === currentEditingId);
                if (idx !== -1) {
                    memos[idx].title = title;
                    memos[idx].content = content;
                    memos[idx].date = new Date().toLocaleDateString();
                }
            } else {
                // Êñ∞Â¢û
                const newMemo = {
                    id: Date.now(),
                    title: title,
                    content: content,
                    pinned: false,
                    date: new Date().toLocaleDateString()
                };
                memos.unshift(newMemo);
            }
            
            saveMemosToStorage();
            renderMemos();
            closeCreateModal();
            showToast('Â∑≤‰øùÂ≠ò');
        }

        // ÈïøÊåâËèúÂçï
        function startLongPress(e, id) {
            if (selectionMode) return;
            activeMemoId = id;
            longPressTimer = setTimeout(() => {
                showContextMenu(e);
            }, 600);
        }

        function cancelLongPress() {
            clearTimeout(longPressTimer);
        }

        function showContextMenu(e) {
            const menu = document.getElementById('context-menu');
            let x = e.clientX || e.touches[0].clientX;
            let y = e.clientY || e.touches[0].clientY;
            
            if (x > 220) x = 220;
            if (y > 700) y = 700;

            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'block';

            setTimeout(() => {
                document.addEventListener('click', hideContextMenu, { once: true });
            }, 100);
        }

        function hideContextMenu() {
            document.getElementById('context-menu').style.display = 'none';
        }

        function handleMenuAction(action) {
            if (!activeMemoId) return;
            const idx = memos.findIndex(m => m.id === activeMemoId);
            if (idx === -1) return;

            if (action === 'delete') {
                memos.splice(idx, 1);
                saveMemosToStorage();
                showToast('Â∑≤Âà†Èô§');
            } else if (action === 'pin') {
                memos[idx].pinned = !memos[idx].pinned;
                saveMemosToStorage();
                showToast(memos[idx].pinned ? 'Â∑≤ÁΩÆÈ°∂' : 'Â∑≤ÂèñÊ∂àÁΩÆÈ°∂');
            }
            renderMemos();
        }

        // ËÆæÁΩÆËèúÂçïÈÄªËæë
        function openMemoSettings(e) {
            e.stopPropagation();
            const menu = document.getElementById('settings-menu');
            if (menu.style.display === 'block') {
                hideSettingsMenu();
            } else {
                menu.style.display = 'block';
                setTimeout(() => {
                    document.addEventListener('click', hideSettingsMenu, { once: true });
                }, 100);
            }
        }
        
        function hideSettingsMenu() {
            document.getElementById('settings-menu').style.display = 'none';
        }

        function handleSettingsAction(action) {
            if (action === 'bg') {
                document.getElementById('widgetBgInput').click();
            } else if (action === 'manage') {
                enterSelectionMode();
            }
        }
        
        // ÈÄâÊã©Ê®°Âºè
        function enterSelectionMode() {
            selectionMode = true;
            selectedMemoIds.clear();
            document.getElementById('memoList').classList.add('selection-mode');
            document.getElementById('appFooter').classList.add('selection-mode');
            renderMemos();
        }

        function exitSelectionMode() {
            selectionMode = false;
            selectedMemoIds.clear();
            document.getElementById('memoList').classList.remove('selection-mode');
            document.getElementById('appFooter').classList.remove('selection-mode');
            renderMemos();
        }

        function handleMemoClick(id) {
            if (selectionMode) {
                if (selectedMemoIds.has(id)) selectedMemoIds.delete(id);
                else selectedMemoIds.add(id);
                renderMemos();
            } else {
                openMemoModal(id);
            }
        }

        function selectAllMemos() {
            if (selectedMemoIds.size === memos.length) {
                selectedMemoIds.clear(); 
            } else {
                selectedMemoIds.clear();
                memos.forEach(m => selectedMemoIds.add(m.id));
            }
            renderMemos();
        }

        function deleteSelectedMemos() {
            if (selectedMemoIds.size === 0) return;
            if (confirm(`Á°ÆÂÆöÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedMemoIds.size} Êù°Â§áÂøòÂΩïÂêóÔºü`)) {
                memos = memos.filter(m => !selectedMemoIds.has(m.id));
                saveMemosToStorage();
                exitSelectionMode();
                showToast('Â∑≤Âà†Èô§');
            }
        }

        // Ê°åÈù¢ÂõæÁâáÊõ¥Êç¢
        function updateWidgetBg(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const widget = document.getElementById('desktopWidget');
                    widget.style.backgroundImage = `url(${e.target.result})`;
                    showToast('ÂõæÁâáÂ∑≤Êõ¥Êîπ');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Â§¥ÂÉèÈ¢ÑËßà
        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var preview = document.getElementById('avatarPreview');
                    preview.style.backgroundImage = 'url(' + e.target.result + ')';
                    preview.style.backgroundColor = 'transparent'; 
                    preview.style.border = 'none'; 
                    preview.innerHTML = ''; 
                    showToast('Â§¥ÂÉèÂ∑≤Êõ¥Êîπ');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // ÂæÆ‰ø°ËèúÂçï‰∏éÊ∑ªÂä†ÂäüËÉΩ
        function toggleWeChatMenu(e) {
            e.stopPropagation();
            const menu = document.getElementById('wechat-plus-menu');
            if (menu.classList.contains('active')) {
                menu.classList.remove('active');
            } else {
                menu.classList.add('active');
                setTimeout(() => {
                    document.addEventListener('click', hideWeChatMenu, { once: true });
                }, 100);
            }
        }

        function hideWeChatMenu() {
            document.getElementById('wechat-plus-menu').classList.remove('active');
        }

        function showWeChatInputModal() {
            hideWeChatMenu();
            document.getElementById('wechat-input-modal-mask').classList.add('active');
            document.getElementById('wechatNewName').value = '';
            document.getElementById('wechatNewName').focus();
        }

        function closeWeChatInputModal() {
            document.getElementById('wechat-input-modal-mask').classList.remove('active');
        }

        function renderChatList() {
            const list = document.getElementById('wechat-chat-list');
            list.innerHTML = '';
            
            // ÊéíÂ∫èÔºöÁΩÆÈ°∂‰ºòÂÖàÔºåÁÑ∂ÂêéÊåâÊó∂Èó¥ÔºàËøôÈáåÁÆÄÂåñ‰∏∫‰øùÊåÅÂéüÊúâÁõ∏ÂØπÈ°∫Â∫èÔºå‰ªÖÁΩÆÈ°∂ÊèêÂâçÔºâ
            // Ê≥®ÊÑèÔºöÁúüÂÆûÈÄªËæëÂ∫îËØ•ÊúâÊó∂Èó¥Êà≥ÔºåËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºåÂè™ÊääÁΩÆÈ°∂ÁöÑÁßªÂà∞ÂâçÈù¢
            let displayList = [...chatListState];
            displayList.sort((a, b) => {
                const isPinnedA = (chatSettingsMap[a.name] && chatSettingsMap[a.name].isPinned) ? 1 : 0;
                const isPinnedB = (chatSettingsMap[b.name] && chatSettingsMap[b.name].isPinned) ? 1 : 0;
                return isPinnedB - isPinnedA;
            });

            displayList.forEach(chat => {
                const settings = chatSettingsMap[chat.name] || {};
                const div = document.createElement('div');
                div.className = `wechat-item ${settings.isPinned ? 'pinned' : ''}`;
                div.onclick = () => openChatDetail(chat.name, chat.avatarClass || '', chat.avatarText);
                
                // Â§ÑÁêÜÂ§áÊ≥®Âêç
                const displayName = settings.remark || chat.name;
                
                // Â§ÑÁêÜÂ§¥ÂÉèÊòæÁ§∫ÂÜÖÂÆπ
                let avatarContent = chat.avatarText;
                let avatarStyle = `background:${chat.bg}`;
                if (settings.avatarData) {
                    avatarContent = `<img src="${settings.avatarData}" style="width:100%;height:100%;object-fit:cover;">`;
                    avatarStyle = 'background:transparent;';
                }

                div.innerHTML = `
                    <div class="wechat-avatar ${chat.avatarClass || ''}" style="${avatarStyle}">${avatarContent}</div>
                    <div class="wechat-content">
                        <div class="wechat-row-1"><span class="wechat-name">${displayName}</span><span class="wechat-time">${chat.time}</span></div>
                        <div class="wechat-row-2"><span class="wechat-msg">${chat.msg}</span></div>
                    </div>
                `;
                list.appendChild(div);
            });
            
            // Ê∏≤ÊüìÈÄöËÆØÂΩï - Â•ΩÂèãÂàóË°® & Áæ§ËÅäÂàóË°®
            const friendsList = document.getElementById('contact-list-friends');
            const groupsList = document.getElementById('contact-list-groups');
            friendsList.innerHTML = '';
            groupsList.innerHTML = '';
            
            chatListState.forEach(chat => {
                if (['ËÆ¢ÈòÖÂè∑Ê∂àÊÅØ', 'Ê∏∏Êàè‰∏≠ÂøÉ', 'Êñá‰ª∂‰º†ËæìÂä©Êâã'].includes(chat.name)) return;
                
                const settings = chatSettingsMap[chat.name] || {};
                const displayName = settings.remark || chat.name;
                const isGroup = chat.avatarClass === 'group' || !!settings.members;
                
                // Â§¥ÂÉèÈÄªËæë
                let avatarContent = chat.avatarText;
                let avatarStyle = '';
                
                if (isGroup) {
                     // Áæ§ËÅäÊ†∑Âºè
                     avatarContent = chat.avatarText || 'üë•';
                     avatarStyle = `background:${chat.bg || '#eeeeee'};border-radius:4px;display:flex;justify-content:center;align-items:center;color:#333;font-size:20px;width:36px;height:36px;margin-right:12px;flex-shrink:0;`;
                     if (settings.avatarData) {
                        avatarContent = `<img src="${settings.avatarData}" style="width:100%;height:100%;object-fit:cover;border-radius:4px;">`;
                        avatarStyle = `background:transparent;width:36px;height:36px;margin-right:12px;flex-shrink:0;`;
                     }
                } else {
                     // Â•ΩÂèãÊ†∑Âºè
                     avatarStyle = `background:${chat.bg || '#ddd'};border-radius:4px;display:flex;justify-content:center;align-items:center;color:#fff;font-size:14px;width:36px;height:36px;margin-right:12px;flex-shrink:0;`;
                     if (settings.avatarData) {
                        avatarContent = `<img src="${settings.avatarData}" style="width:100%;height:100%;object-fit:cover;border-radius:4px;">`;
                        avatarStyle = `background:transparent;width:36px;height:36px;margin-right:12px;flex-shrink:0;`;
                     } else {
                         // ÈªòËÆ§Â§¥ÂÉè
                         if (!avatarContent) avatarContent = displayName[0];
                         // Â¶ÇÊûúÊòØemojiÔºåË∞ÉÊï¥Â§ßÂ∞è
                         if (avatarContent.match && avatarContent.match(/[\uD800-\uDBFF][\uDC00-\uDFFF]/)) {
                             avatarStyle += 'font-size:20px;background:transparent;';
                         }
                     }
                }

                const div = document.createElement('div');
                div.className = 'wechat-cell';
                div.onclick = () => openChatDetail(chat.name, chat.avatarClass || (isGroup ? 'group' : ''), chat.avatarText);
                div.innerHTML = `
                    <div style="${avatarStyle}">${avatarContent}</div>
                    <div class="wechat-cell-text">${displayName}</div>
                `;
                
                if (isGroup) {
                    groupsList.appendChild(div);
                } else {
                    friendsList.appendChild(div);
                }
            });
            
            // Â¶ÇÊûúÂàóË°®‰∏∫Á©∫ÔºåÊòæÁ§∫ÊèêÁ§∫
            if (friendsList.children.length === 0) {
                friendsList.innerHTML = '<div style="padding:15px;text-align:center;color:#ccc;font-size:13px;">ÊöÇÊó†Â•ΩÂèã</div>';
            }
            if (groupsList.children.length === 0) {
                groupsList.innerHTML = '<div style="padding:15px;text-align:center;color:#ccc;font-size:13px;">ÊöÇÊó†Áæ§ËÅä</div>';
            }
        }

        function confirmWeChatAdd() {
            const name = document.getElementById('wechatNewName').value.trim();
            if (!name) {
                showToast('ËØ∑ËæìÂÖ•ÂêçÂ≠ó');
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
            if (chatListState.some(c => c.name === name)) {
                showToast('Â•ΩÂèãÂ∑≤Â≠òÂú®');
                closeWeChatInputModal();
                openChatDetail(name, 'blue', name[0]);
                return;
            }

            // Ê∑ªÂä†Êñ∞Êï∞ÊçÆ
            const newChat = {
                name: name,
                avatarClass: 'blue',
                avatarText: name[0],
                bg: '#10aeff',
                time: 'ÂàöÂàö',
                msg: '' // Êó†ÈªòËÆ§Ê∂àÊÅØ
            };
            
            chatListState.unshift(newChat);
            saveChatListToStorage();
            renderChatList();

            closeWeChatInputModal();
            showToast('Â∑≤Ê∑ªÂä†');
            
            openChatDetail(name, 'blue', name[0]);
        }
        
        function deleteCurrentContact() {
            showIOSDialog(
                'Âà†Èô§ËÅîÁ≥ª‰∫∫',
                `Á°ÆÂÆöË¶ÅÂà†Èô§‚Äú${currentChatUser}‚ÄùÂêóÔºüËøôÂ∞ÜÊ∏ÖÁ©∫Áõ∏ÂÖ≥Êï∞ÊçÆ„ÄÇ`,
                () => {
                    // 1. ‰ªéÂàóË°®Êï∞ÊçÆ‰∏≠ÁßªÈô§
                    chatListState = chatListState.filter(c => c.name !== currentChatUser);
                    saveChatListToStorage();
                    
                    // 2. ÁßªÈô§ËÆæÁΩÆÊï∞ÊçÆ
                    if (chatSettingsMap[currentChatUser]) {
                        delete chatSettingsMap[currentChatUser];
                        saveChatSettingsToStorage();
                    }
                    
                    // 3. ÈáçÊñ∞Ê∏≤ÊüìÂπ∂ÂÖ≥Èó≠
                    renderChatList();
                    closeChatSettings();
                    closeChatDetail();
                    showToast('Â∑≤Âà†Èô§');
                },
                null,
                'ÂèñÊ∂à',
                'Âà†Èô§'
            );
        }

        // Áæ§ËÅäÁõ∏ÂÖ≥ÈÄªËæë
        function showGroupCreateModal() {
            hideWeChatMenu();
            const modal = document.getElementById('wechat-group-create-modal');
            const list = document.getElementById('group-contact-list');
            list.innerHTML = '';

            // ËøáÊª§Âá∫ÂèØÊãâÂÖ•Áæ§ËÅäÁöÑÂ•ΩÂèãÔºàÊéíÈô§Á≥ªÁªüÂè∑ÂíåËá™Â∑±Ôºâ
            const friends = chatListState.filter(c => 
                !['ËÆ¢ÈòÖÂè∑Ê∂àÊÅØ', 'Ê∏∏Êàè‰∏≠ÂøÉ', 'Êñá‰ª∂‰º†ËæìÂä©Êâã'].includes(c.name)
            );

            if (friends.length === 0) {
                list.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">ÊöÇÊó†Â•ΩÂèãÂèØÈÄâ</div>';
            } else {
                friends.forEach(friend => {
                    const settings = chatSettingsMap[friend.name] || {};
                    const displayName = settings.remark || friend.name;
                    
                    // Â§¥ÂÉèÈÄªËæë
                    let avatarContent = friend.avatarText;
                    let avatarStyle = `background:${friend.bg || '#ddd'};border-radius:4px;display:flex;justify-content:center;align-items:center;color:#fff;font-size:12px;width:36px;height:36px;margin-right:12px;`;
                    if (settings.avatarData) {
                        avatarContent = `<img src="${settings.avatarData}" style="width:100%;height:100%;object-fit:cover;border-radius:4px;">`;
                        avatarStyle = `background:transparent;width:36px;height:36px;margin-right:12px;`;
                    } else if (!avatarContent && friend.avatarClass) {
                        // ÂÖºÂÆπ class
                         avatarStyle = `background:${friend.bg || '#ddd'};border-radius:4px;display:flex;justify-content:center;align-items:center;color:#fff;font-size:12px;width:36px;height:36px;margin-right:12px;`;
                         // ÁÆÄÂçïÂ§ÑÁêÜÔºåÂ¶ÇÊûúÊ≤°ÂÜÖÂÆπÂ∞±ÊòæÁ§∫È¶ñÂ≠ó
                         if(!avatarContent) avatarContent = displayName[0];
                    }

                    const div = document.createElement('div');
                    div.className = 'wechat-cell';
                    div.style.padding = '10px 15px';
                    // ÁÇπÂáªÊï¥‰∏™Ë°åÂàáÊç¢ checkbox
                    div.onclick = (e) => {
                        const cb = div.querySelector('input[type="checkbox"]');
                        if (e.target !== cb) {
                            cb.checked = !cb.checked;
                        }
                    };

                    div.innerHTML = `
                        <div style="${avatarStyle}">${avatarContent}</div>
                        <div class="wechat-cell-text" style="font-size:16px;">${displayName}</div>
                        <input type="checkbox" value="${friend.name}" style="width:20px;height:20px;accent-color:#07C160;">
                    `;
                    list.appendChild(div);
                });
            }

            modal.classList.add('active');
        }

        function closeGroupCreateModal() {
            document.getElementById('wechat-group-create-modal').classList.remove('active');
        }
        
        function createGroupChat() {
            const list = document.getElementById('group-contact-list');
            const checkboxes = list.querySelectorAll('input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                showToast('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Â•ΩÂèã');
                return;
            }

            const selectedNames = Array.from(checkboxes).map(cb => cb.value);
            // ÁîüÊàêÁæ§ÂêçÔºàÂèñÂâç‰∏â‰∏™ÂêçÂ≠ó + Á≠âÔºâ
            let groupName = selectedNames.slice(0, 3).join('„ÄÅ');
            if (selectedNames.length > 3) groupName += 'Á≠â';
            groupName += `(${selectedNames.length + 1})`; // +1 ÂåÖÂê´Ëá™Â∑±

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêçÁæ§ËÅäÔºàÁÆÄÂçïÊ£ÄÊü•Ôºâ
            if (chatListState.some(c => c.name === groupName)) {
                // Â¶ÇÊûúÂ≠òÂú®Ôºå‰∏∫‰∫ÜÊºîÁ§∫ÊïàÊûúÔºåÂä†‰∏™Êó∂Èó¥Êà≥ÊàñËÄÖÈöèÊú∫Êï∞
                groupName += '_' + Math.floor(Math.random() * 100);
            }

            // ÂàõÂª∫Êñ∞‰ºöËØù
            const newChat = {
                name: groupName,
                avatarClass: 'group', // ÁâπÊÆäÊ†áËØÜ
                avatarText: 'üë•',
                bg: '#eeeeee',
                time: 'ÂàöÂàö',
                msg: '‰Ω†ÂàõÂª∫‰∫ÜÁæ§ËÅä'
            };

            // Ê∑ªÂä†Âà∞ÂàóË°®È°∂ÈÉ®
            chatListState.unshift(newChat);
            saveChatListToStorage();
            
            // ÂàùÂßãÂåñÁæ§ËÅäËÆæÁΩÆ
            chatSettingsMap[groupName] = {
                remark: groupName, // ÈªòËÆ§Â§áÊ≥®‰πüÊòØÁæ§Âêç
                friendPersona: 'Áæ§ËÅäÊàêÂëò', // ÁÆÄÂçïÈ¢ÑËÆæ
                myPersona: '',
                members: selectedNames // ‰øùÂ≠òÁæ§ÊàêÂëòÂàóË°®
            };
            saveChatSettingsToStorage();

            renderChatList();
            closeGroupCreateModal();
            
            // ÊâìÂºÄÊñ∞Áæ§ËÅä
            openChatDetail(groupName, 'group', 'üë•');
            
            // Âèë‰∏ÄÊù°Á≥ªÁªüÊ∂àÊÅØ
            addChatMessage(groupName, `‰Ω†ÈÇÄËØ∑ ${selectedNames.join('„ÄÅ')} Âä†ÂÖ•‰∫ÜÁæ§ËÅä`, false); // ËøôÈáåÁ®çÂæÆ hack ‰∏Ä‰∏ãÔºåÁæ§ËÅäÁ≥ªÁªüÊ∂àÊÅØ‰πüÂΩì‰ΩúÂØπÊñπÊ∂àÊÅØÊòæÁ§∫ÔºåÊàñËÄÖÂèØ‰ª•Âú® addChatMessage ÈáåÊâ©Â±ï logic
        }

        // ËÅäÂ§©ËÆæÁΩÆÁõ∏ÂÖ≥
        function openChatSettings() {
            const modal = document.getElementById('wechat-settings-modal');
            const data = chatSettingsMap[currentChatUser] || {};
            const isGroup = !!data.members;

            // Êõ¥Êñ∞ÁïåÈù¢ÊñáÊ°à
            document.getElementById('labelFriendName').innerText = isGroup ? 'Áæ§ËÅäÂêçÁß∞' : 'Â•ΩÂèãÂßìÂêç';
            document.getElementById('labelFriendAvatar').innerText = isGroup ? 'Áæ§ËÅäÂ§¥ÂÉè' : 'Â•ΩÂèãÂ§¥ÂÉè';
            document.getElementById('titleFriendPersona').innerText = isGroup ? 'Áæ§ËÅäËÆæÂÆö' : 'Â•ΩÂèã‰∫∫ËÆæ';

            // ÈáçÁΩÆ‰∏¥Êó∂Êï∞ÊçÆ
            tempAvatarData = null;
            tempBgData = null;
            tempMyAvatarData = null;

            document.getElementById('wsFriendName').value = currentChatUser;
            document.getElementById('wsRemark').value = data.remark || '';
            document.getElementById('wsFriendPersona').value = data.friendPersona || '';
            document.getElementById('wsMyPersona').value = data.myPersona || '';
            document.getElementById('wsMemoryThreshold').value = data.memoryThreshold || '';
            document.getElementById('wsCustomCss').value = data.customCss || '';
            
            // ÂàùÂßãÂåñÁΩÆÈ°∂ÂºÄÂÖ≥
            document.getElementById('wsIsPinned').checked = !!data.isPinned;
            
            // È¢ÑËßàËÉåÊôØÁä∂ÊÄÅ
            const bgPreview = document.getElementById('wsBgPreview');
            if (data.chatBg) {
                 bgPreview.innerHTML = '<img src="' + data.chatBg + '" style="width:100%;height:100%;object-fit:cover;">';
                 bgPreview.style.background = 'transparent';
            } else {
                 bgPreview.innerText = 'ÈªòËÆ§';
                 bgPreview.style.background = 'transparent';
            }
            
            // È¢ÑËßà‚ÄúÊàëÁöÑÂ§¥ÂÉè‚Äù
            const myAvatarDiv = document.getElementById('wsMyAvatar');
            myAvatarDiv.innerHTML = '';
            if (data.myAvatarData) {
                myAvatarDiv.style.background = 'transparent';
                myAvatarDiv.innerHTML = `<img src="${data.myAvatarData}" style="width:100%;height:100%;object-fit:cover;">`;
            } else {
                myAvatarDiv.style.background = '#eee';
                myAvatarDiv.innerText = 'ME';
                myAvatarDiv.style.color = '#333';
            }

            // Ê∏≤ÊüìËÆæÁΩÆÈ°µ‰∏≠ÁöÑËÆ∞ÂøÜÂàóË°®
            renderSettingsMemoryList();

            // Â§¥ÂÉèÊòæÁ§∫
            const avatarDiv = document.getElementById('wsFriendAvatar');
            avatarDiv.innerHTML = ''; // Ê∏ÖÁ©∫
            avatarDiv.className = `ws-avatar-preview ${currentChatColor}`;
            
            if (data.avatarData) {
                // ÊúâËá™ÂÆö‰πâÂ§¥ÂÉè
                avatarDiv.style.background = 'transparent';
                avatarDiv.innerHTML = `<img src="${data.avatarData}" style="width:100%;height:100%;object-fit:cover;">`;
            } else {
                // ÈªòËÆ§ÈÄªËæë
                if (currentChatUser.length === 1 || !currentChatAvatar.match(/[\uD800-\uDBFF][\uDC00-\uDFFF]/)) {
                     // ÂèØËÉΩÊòØÂêçÂ≠óÁº©ÂÜôÊàñÊñáÊú¨
                     avatarDiv.style.background = currentChatColor === 'green' ? '#07C160' : (currentChatColor === 'orange' ? '#fa9d3b' : '#10aeff');
                     avatarDiv.innerText = currentChatAvatar;
                } else {
                     // ÂèØËÉΩÊòØEmoji
                     avatarDiv.style.background = 'transparent';
                     avatarDiv.innerText = currentChatAvatar;
                     avatarDiv.style.fontSize = '24px';
                }
            }

            // ÂàùÂßãÂåñÊ†∑ÂºèÈ¢ÑËßà
            initSettingsShadowDom(data.customCss || '');
            modal.classList.add('active');
        }

        function closeChatSettings() {
            document.getElementById('wechat-settings-modal').classList.remove('active');
        }
        
        // È¢ÑËßàËÆæÁΩÆ‰∏≠ÁöÑÂ§¥ÂÉè
        function previewSettingsAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempAvatarData = e.target.result;
                    const avatarDiv = document.getElementById('wsFriendAvatar');
                    avatarDiv.style.background = 'transparent';
                    avatarDiv.innerHTML = `<img src="${tempAvatarData}" style="width:100%;height:100%;object-fit:cover;">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // È¢ÑËßàËÆæÁΩÆ‰∏≠ÁöÑËÉåÊôØ
        function previewSettingsBg(input) {
             if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempBgData = e.target.result;
                    const bgPreview = document.getElementById('wsBgPreview');
                    bgPreview.style.background = 'transparent';
                    bgPreview.innerHTML = `<img src="${tempBgData}" style="width:100%;height:100%;object-fit:cover;">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // È¢ÑËßàËÆæÁΩÆ‰∏≠ÁöÑ‚ÄúÊàëÁöÑÂ§¥ÂÉè‚Äù
        function previewSettingsMyAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempMyAvatarData = e.target.result;
                    const myAvatarDiv = document.getElementById('wsMyAvatar');
                    myAvatarDiv.style.background = 'transparent';
                    myAvatarDiv.innerHTML = `<img src="${tempMyAvatarData}" style="width:100%;height:100%;object-fit:cover;">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveChatSettings() {
            const newName = document.getElementById('wsFriendName').value.trim();
            const remark = document.getElementById('wsRemark').value.trim();
            const fPersona = document.getElementById('wsFriendPersona').value;
            const mPersona = document.getElementById('wsMyPersona').value;
            const isPinned = document.getElementById('wsIsPinned').checked;
            const customCss = document.getElementById('wsCustomCss').value;
            
            if (!newName) {
                showToast('ÂßìÂêç‰∏çËÉΩ‰∏∫Á©∫');
                return;
            }

            // Â§ÑÁêÜÊîπÂêçÈÄªËæë
            if (newName !== currentChatUser) {
                // Ê£ÄÊü•ÈáçÂêç
                if (chatListState.some(c => c.name === newName)) {
                    showToast('ËØ•ÂêçÂ≠óÂ∑≤Â≠òÂú®');
                    return;
                }
                
                // Êõ¥Êñ∞ chatListState
                const chatIdx = chatListState.findIndex(c => c.name === currentChatUser);
                if (chatIdx !== -1) {
                    chatListState[chatIdx].name = newName;
                }
                
                // ËøÅÁßª settings
                chatSettingsMap[newName] = chatSettingsMap[currentChatUser] || {};
                delete chatSettingsMap[currentChatUser];
                
                // Êõ¥Êñ∞ÂΩìÂâçÊåáÈíà
                currentChatUser = newName;
            }
            
            // Á°Æ‰øùÂØπË±°Â≠òÂú®
            if (!chatSettingsMap[currentChatUser]) chatSettingsMap[currentChatUser] = {};
            
            // Êõ¥Êñ∞Â≠óÊÆµ
            chatSettingsMap[currentChatUser].remark = remark;
            chatSettingsMap[currentChatUser].friendPersona = fPersona;
            chatSettingsMap[currentChatUser].myPersona = mPersona;
            chatSettingsMap[currentChatUser].isPinned = isPinned;
            chatSettingsMap[currentChatUser].customCss = customCss;
            
            // ËÆ∞ÂøÜÈòàÂÄº
            const memThreshold = parseInt(document.getElementById('wsMemoryThreshold').value);
            if (memThreshold > 0) {
                chatSettingsMap[currentChatUser].memoryThreshold = memThreshold;
            } else {
                delete chatSettingsMap[currentChatUser].memoryThreshold; // ÊÅ¢Â§çÈªòËÆ§ÈÄªËæë
            }
            
            // Êõ¥Êñ∞Â§¥ÂÉè
            if (tempAvatarData) {
                chatSettingsMap[currentChatUser].avatarData = tempAvatarData;
            }
            
            // Êõ¥Êñ∞ËÉåÊôØ
            if (tempBgData) {
                chatSettingsMap[currentChatUser].chatBg = tempBgData;
            }
            
            // Êõ¥Êñ∞ÊàëÁöÑÂ§¥ÂÉè
            if (tempMyAvatarData) {
                chatSettingsMap[currentChatUser].myAvatarData = tempMyAvatarData;
            }
            
            saveChatSettingsToStorage();
            saveChatListToStorage();
            
            // Âà∑Êñ∞ÁïåÈù¢
            renderChatList();
            
            // Êõ¥Êñ∞ËØ¶ÊÉÖÈ°µÊ†áÈ¢ò
            document.getElementById('chatTitle').innerText = remark || currentChatUser;
            
            // Á´ãÂç≥Â∫îÁî®Êñ∞ËÉåÊôØ
            const data = chatSettingsMap[currentChatUser];
            const detailPage = document.getElementById('wechat-chat-detail');
            if (data.chatBg) {
                detailPage.style.backgroundImage = `url(${data.chatBg})`;
                detailPage.style.backgroundSize = 'cover';
                detailPage.style.backgroundPosition = 'center';
            } else {
                detailPage.style.backgroundImage = 'none';
                detailPage.style.backgroundColor = '#ededed';
            }
            
            // Á´ãÂç≥Â∫îÁî®Êñ∞ CSS
            document.getElementById('dynamic-chat-style').innerHTML = customCss || '';
            
            showToast('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
            closeChatSettings();
        }

        // ÂàùÂßãÂåñÂíåÊõ¥Êñ∞Ê†∑ÂºèÈ¢ÑËßà
        function initSettingsShadowDom(initialCss) {
            const container = document.getElementById('wsBubblePreviewContainer');
            // Ê∏ÖÁ©∫ÊóßÁöÑ Shadow Root
            if (shadowRoot) {
                // Shadow Root ‰∏çËÉΩÂà†Èô§ÔºåÂè™ËÉΩÊ∏ÖÁ©∫ÂÜÖÂÆπ
                shadowRoot.innerHTML = '';
            } else {
                shadowRoot = container.attachShadow({mode: 'open'});
            }

            // Âü∫Á°ÄÊ†∑Âºè (Â§çÂàª index.html ÈáåÁöÑÊ∞îÊ≥°Áõ∏ÂÖ≥Ê†∑Âºè)
            const baseStyle = `
                * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Helvetica Neue", Helvetica, Arial, sans-serif; }
                .preview-box { padding: 15px; display: flex; flex-direction: column; gap: 15px; }
                .chat-msg-row { display: flex; align-items: flex-start; gap: 10px; }
                .chat-msg-row.self { flex-direction: row-reverse; }
                .chat-avatar { width: 36px; height: 36px; border-radius: 4px; background: #ddd; flex-shrink: 0; display:flex; justify-content:center; align-items:center; color:white; font-size: 14px; }
                .chat-msg-content { display: flex; flex-direction: column; align-items: flex-start; max-width: 80%; }
                .chat-msg-row.self .chat-msg-content { align-items: flex-end; }
                .chat-bubble { padding: 10px 12px; border-radius: 4px; font-size: 14px; line-height: 1.4; position: relative; background: #fff; color: #000; }
                .chat-msg-row:not(.self) .chat-bubble::before { content: ""; position: absolute; top: 12px; left: -6px; width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-right: 6px solid #fff; }
                .chat-msg-row.self .chat-bubble { background: #95ec69; color: #000; }
                .chat-msg-row.self .chat-bubble::before { content: ""; position: absolute; top: 12px; right: -6px; width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 6px solid #95ec69; }
            `;

            // ÊûÑÈÄ† Shadow DOM ÂÜÖÂÆπ
            shadowRoot.innerHTML = `
                <style>${baseStyle}</style>
                <style id="preview-custom-style">${initialCss}</style>
                <div class="preview-box">
                    <div class="chat-msg-row">
                        <div class="chat-avatar">TA</div>
                        <div class="chat-msg-content">
                            <div class="chat-bubble">ÂØπÊñπÁöÑÊ∂àÊÅØÊ∞îÊ≥°</div>
                        </div>
                    </div>
                    <div class="chat-msg-row self">
                        <div class="chat-avatar" style="background:#eee;color:#333;">ME</div>
                        <div class="chat-msg-content">
                            <div class="chat-bubble">ÊàëÁöÑÊ∂àÊÅØÊ∞îÊ≥°</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateBubblePreview() {
            if (!shadowRoot) return;
            const css = document.getElementById('wsCustomCss').value;
            const styleTag = shadowRoot.getElementById('preview-custom-style');
            if (styleTag) {
                styleTag.innerHTML = css;
            }
        }

        // ================= ËÆ∞ÂøÜÁÆ°ÁêÜÔºàËÆæÁΩÆÈ°µÁâàÔºâ =================

        function renderSettingsMemoryList() {
            const settings = chatSettingsMap[currentChatUser] || {};
            const memories = settings.memoryList || [];
            const container = document.getElementById('wsMemoryListContainer');
            container.innerHTML = '';

            if (memories.length === 0) {
                container.innerHTML = '<div style="padding:15px;text-align:center;color:#999;font-size:14px;">ÊöÇÊó†ËÆ∞ÂøÜÊëòË¶Å</div>';
                return;
            }

            // ÂÄíÂ∫èÊòæÁ§∫Ôºå‰∏∫‰∫ÜÊñπ‰æøÊìç‰ΩúÔºåÁªôÊØè‰∏™ item ÁªëÂÆöÂéüÂßã index
            const displayList = memories.map((m, i) => ({...m, originalIndex: i})).reverse();

            displayList.forEach(mem => {
                const div = document.createElement('div');
                div.style.borderBottom = '1px solid #f0f0f0';
                div.style.padding = '12px 15px';
                div.id = `ws-memory-item-${mem.originalIndex}`;
                
                // Ê≠£Â∏∏ÊòæÁ§∫ËßÜÂõæ
                const viewHTML = `
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span style="font-size:12px;color:#999;">${mem.time}</span>
                        <div style="display:flex;gap:15px;">
                            <span style="font-size:13px;color:#576b95;cursor:pointer;" onclick="toggleEditMemoryInSettings(${mem.originalIndex})">ÁºñËæë</span>
                            <span style="font-size:13px;color:#ff3b30;cursor:pointer;" onclick="deleteMemoryInSettings(${mem.originalIndex})">Âà†Èô§</span>
                        </div>
                    </div>
                    <div style="font-size:15px;line-height:1.5;color:#333;white-space:pre-wrap;">${mem.content}</div>
                `;

                // ÁºñËæëËßÜÂõæ
                const editHTML = `
                    <div style="margin-bottom:8px;font-size:13px;color:#999;">ÁºñËæëËÆ∞ÂøÜ</div>
                    <textarea id="ws-memory-edit-${mem.originalIndex}" class="ws-textarea" style="background:#f9f9f9;padding:8px;border-radius:4px;border:1px solid #eee;min-height:100px;">${mem.content}</textarea>
                    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
                        <div class="ws-btn cancel" style="padding:6px 15px;font-size:14px;min-width:auto;" onclick="toggleEditMemoryInSettings(${mem.originalIndex})">ÂèñÊ∂à</div>
                        <div class="ws-btn save" style="padding:6px 15px;font-size:14px;min-width:auto;" onclick="saveMemoryEditInSettings(${mem.originalIndex})">‰øùÂ≠ò</div>
                    </div>
                `;

                div.innerHTML = viewHTML;
                div.dataset.editMode = 'false';
                div.dataset.viewHtml = viewHTML;
                div.dataset.editHtml = editHTML;
                
                container.appendChild(div);
            });
        }

        function addManualMemoryFromSettings() {
            const content = prompt("ËØ∑ËæìÂÖ•ËÆ∞ÂøÜÂÜÖÂÆπÔºö");
            if (content && content.trim()) {
                const settings = chatSettingsMap[currentChatUser];
                if (!settings.memoryList) settings.memoryList = [];
                // Ê∑ªÂä†Âà∞ÂàóË°®
                settings.memoryList.push({
                    time: new Date().toLocaleString(),
                    content: content.trim()
                });
                saveChatSettingsToStorage();
                renderSettingsMemoryList();
                updateMemoryBar(); // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢È°∂ÈÉ®ÁöÑÊù°
                
                // Â¶ÇÊûúÊÇ¨ÊµÆÈù¢Êùø‰πüÊòØÂºÄÁùÄÁöÑÔºåÈ°∫‰æøÂà∑Êñ∞‰∏Ä‰∏ãÔºàËôΩÁÑ∂Ê≠§Êó∂Ë¢´ËÆæÁΩÆÂºπÁ™óÊå°‰ΩèÁúã‰∏çËßÅÔºâ
                if (document.getElementById('memory-list-panel').classList.contains('active')) {
                    renderMemoryList();
                }
                showToast("Â∑≤Ê∑ªÂä†ËÆ∞ÂøÜ");
            }
        }

        function toggleEditMemoryInSettings(index) {
            const div = document.getElementById(`ws-memory-item-${index}`);
            if (!div) return;
            
            const isEdit = div.dataset.editMode === 'true';
            
            if (isEdit) {
                // ÂàáÊç¢ÂõûÊü•Áúã
                div.innerHTML = div.dataset.viewHtml;
                div.dataset.editMode = 'false';
            } else {
                // ÂàáÊç¢Âà∞ÁºñËæë
                div.innerHTML = div.dataset.editHtml;
                div.dataset.editMode = 'true';
            }
        }

        function saveMemoryEditInSettings(index) {
            const textarea = document.getElementById(`ws-memory-edit-${index}`);
            if (!textarea) return;
            
            const newContent = textarea.value.trim();
            if (!newContent) {
                showToast('ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫');
                return;
            }
            
            const settings = chatSettingsMap[currentChatUser];
            if (settings && settings.memoryList && settings.memoryList[index]) {
                settings.memoryList[index].content = newContent;
                saveChatSettingsToStorage();
                showToast('ËÆ∞ÂøÜÂ∑≤Êõ¥Êñ∞');
                renderSettingsMemoryList();
                
                // ÂêåÊ≠•Êõ¥Êñ∞ÊÇ¨ÊµÆÈù¢ÊùøÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                if (document.getElementById('memory-list-panel').classList.contains('active')) {
                    renderMemoryList();
                }
            }
        }

        function deleteMemoryInSettings(index) {
            showIOSDialog(
                'Âà†Èô§ËÆ∞ÂøÜ',
                'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂøÜÂêóÔºü',
                () => {
                    const settings = chatSettingsMap[currentChatUser];
                    if (settings && settings.memoryList) {
                        settings.memoryList.splice(index, 1);
                        saveChatSettingsToStorage();
                        showToast('ËÆ∞ÂøÜÂ∑≤Âà†Èô§');
                        renderSettingsMemoryList();
                        updateMemoryBar();
                        
                        // ÂêåÊ≠•Êõ¥Êñ∞ÊÇ¨ÊµÆÈù¢Êùø
                        if (document.getElementById('memory-list-panel').classList.contains('active')) {
                            renderMemoryList();
                        }
                    }
                },
                null,
                'ÂèñÊ∂à',
                'Âà†Èô§'
            );
        }

    </script>
</body>
</html>
